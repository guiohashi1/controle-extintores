<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Login Admin</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: #f5f5f5;
        }
        .debug-section {
            background: white;
            padding: 1.5rem;
            margin: 1rem 0;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .success { border-left: 4px solid #4caf50; }
        .error { border-left: 4px solid #f44336; }
        .warning { border-left: 4px solid #ff9800; }
        .info { border-left: 4px solid #2196f3; }
        pre { 
            background: #f0f0f0; 
            padding: 1rem; 
            border-radius: 4px; 
            overflow-x: auto; 
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin: 0.5rem 0;
        }
        button:hover { background: #0056b3; }
        input { 
            padding: 0.5rem; 
            margin: 0.5rem; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            width: 200px;
        }
        .login-form {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <h1>🔍 Debug Sistema Login Admin</h1>

    <div class="debug-section info">
        <h3>ℹ️ Informações do Sistema</h3>
        <p>Esta página ajuda a debugar problemas de login no painel admin.</p>
        <p><strong>Usuário Admin de Teste:</strong> admin@teste.com | Senha: admin123</p>
    </div>

    <div class="debug-section" id="dependencies">
        <h3>📦 Dependências</h3>
        <div id="deps-info">Carregando...</div>
        <button onclick="checkDependencies()">🔍 Verificar Dependências</button>
    </div>

    <div class="debug-section" id="current-user">
        <h3>👤 Usuário Atual</h3>
        <div id="user-info">Carregando...</div>
        <button onclick="checkCurrentUser()">🔍 Verificar Usuário</button>
    </div>

    <div class="debug-section" id="login-section">
        <h3>🔐 Teste de Login</h3>
        <div class="login-form">
            <input type="email" id="login-email" placeholder="Email" value="admin@teste.com">
            <input type="password" id="login-password" placeholder="Senha" value="admin123">
            <button onclick="testLogin()">🔐 Fazer Login</button>
        </div>
        <div id="login-result">Faça login para testar</div>
    </div>

    <div class="debug-section" id="admin-check">
        <h3>👑 Verificação Admin</h3>
        <div id="admin-info">Execute a verificação</div>
        <button onclick="checkAdminStatus()">👑 Verificar Status Admin</button>
    </div>

    <div class="debug-section" id="supabase-test">
        <h3>🗄️ Teste Supabase</h3>
        <div id="supabase-info">Execute o teste</div>
        <button onclick="testSupabase()">🗄️ Testar Conexão</button>
    </div>

    <div class="debug-section" id="admin-access">
        <h3>🎛️ Acesso ao Admin</h3>
        <div id="access-info">Faça login primeiro</div>
        <button onclick="tryAccessAdmin()" id="admin-btn" disabled>🎛️ Tentar Acessar Admin</button>
    </div>

    <script src="js/supabase-config.js"></script>
    <script>
        // Verificar dependências
        function checkDependencies() {
            const depsDiv = document.getElementById('deps-info');
            let html = '<strong>Status das Dependências:</strong><br>';
            
            const checks = [
                { name: 'window.supabase', available: typeof window.supabase !== 'undefined' },
                { name: 'supabase (manager)', available: typeof supabase !== 'undefined' },
                { name: 'PlanValidator', available: typeof PlanValidator !== 'undefined' },
                { name: 'isAdmin function', available: typeof isAdmin === 'function' },
                { name: 'navigateToAdmin function', available: typeof navigateToAdmin === 'function' }
            ];
            
            checks.forEach(check => {
                const status = check.available ? '✅' : '❌';
                html += `${status} ${check.name}: ${check.available}<br>`;
            });
            
            depsDiv.innerHTML = html;
            document.getElementById('dependencies').className = 'debug-section ' + 
                (checks.every(c => c.available) ? 'success' : 'warning');
        }

        // Verificar usuário atual
        function checkCurrentUser() {
            const userDiv = document.getElementById('user-info');
            let html = '<strong>Status do Usuário:</strong><br>';
            
            // Verificar sessionStorage
            let sessionUser = null;
            try {
                const sessionData = sessionStorage.getItem('currentUser');
                if (sessionData) {
                    sessionUser = JSON.parse(sessionData);
                }
            } catch (e) {}
            
            // Verificar supabase manager
            let supabaseUser = null;
            if (typeof supabase !== 'undefined') {
                supabaseUser = supabase.currentUser;
            }
            
            html += `📝 sessionStorage: ${sessionUser ? '✅ ' + sessionUser.email : '❌ Vazio'}<br>`;
            html += `🔧 supabase.currentUser: ${supabaseUser ? '✅ ' + supabaseUser.email : '❌ Vazio'}<br>`;
            
            if (sessionUser) {
                html += `<br><strong>Dados sessionStorage:</strong><br>`;
                html += `<pre>${JSON.stringify(sessionUser, null, 2)}</pre>`;
            }
            
            userDiv.innerHTML = html;
            document.getElementById('current-user').className = 'debug-section ' + 
                (sessionUser || supabaseUser ? 'success' : 'error');
        }

        // Teste de login
        async function testLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const resultDiv = document.getElementById('login-result');
            
            try {
                resultDiv.innerHTML = '⏳ Fazendo login...';
                
                if (typeof supabase === 'undefined') {
                    throw new Error('Supabase manager não disponível');
                }
                
                const result = await supabase.login(email, password);
                
                if (result) {
                    resultDiv.innerHTML = '✅ <strong>Login realizado com sucesso!</strong>';
                    document.getElementById('login-section').className = 'debug-section success';
                    document.getElementById('admin-btn').disabled = false;
                    
                    // Atualizar outros testes
                    setTimeout(() => {
                        checkCurrentUser();
                        checkAdminStatus();
                    }, 500);
                } else {
                    resultDiv.innerHTML = '❌ <strong>Falha no login</strong> - Credenciais inválidas ou usuário não existe';
                    document.getElementById('login-section').className = 'debug-section error';
                }
            } catch (error) {
                resultDiv.innerHTML = `❌ <strong>Erro no login:</strong> ${error.message}`;
                document.getElementById('login-section').className = 'debug-section error';
            }
        }

        // Verificar status admin
        function checkAdminStatus() {
            const adminDiv = document.getElementById('admin-info');
            let html = '<strong>Verificação de Admin:</strong><br>';
            
            // Pegar usuário atual
            let user = null;
            try {
                const sessionData = sessionStorage.getItem('currentUser');
                if (sessionData) {
                    user = JSON.parse(sessionData);
                }
            } catch (e) {}
            
            if (!user && typeof supabase !== 'undefined') {
                user = supabase.currentUser;
            }
            
            if (!user) {
                html += '❌ Nenhum usuário logado<br>';
                adminDiv.innerHTML = html;
                document.getElementById('admin-check').className = 'debug-section error';
                return;
            }
            
            html += `👤 Usuário: ${user.email}<br>`;
            html += `🔑 user.admin: ${user.admin}<br>`;
            html += `🏷️ user.tipo: ${user.tipo}<br>`;
            html += `📦 user.plan: ${user.plan}<br>`;
            
            // Verificar se é admin
            const isUserAdmin = user.admin === true || user.tipo === 'admin';
            const adminEmails = ['admin@teste.com', 'admin@extintores.com'];
            const isInAdminList = adminEmails.includes(user.email);
            const isDev = window.location.hostname.includes('localhost') || 
                         window.location.hostname.includes('127.0.0.1') ||
                         window.location.hostname.includes('netlify');
            
            html += `<br><strong>Verificações:</strong><br>`;
            html += `✔️ user.admin === true: ${user.admin === true}<br>`;
            html += `✔️ user.tipo === 'admin': ${user.tipo === 'admin'}<br>`;
            html += `✔️ Email na lista admin: ${isInAdminList}<br>`;
            html += `✔️ Modo desenvolvimento: ${isDev}<br>`;
            
            const finalAdminStatus = isUserAdmin || isInAdminList || (isDev && user.email);
            html += `<br><strong>🎯 RESULTADO FINAL: ${finalAdminStatus ? '✅ É ADMIN' : '❌ NÃO É ADMIN'}</strong>`;
            
            adminDiv.innerHTML = html;
            document.getElementById('admin-check').className = 'debug-section ' + 
                (finalAdminStatus ? 'success' : 'error');
        }

        // Testar Supabase
        async function testSupabase() {
            const supabaseDiv = document.getElementById('supabase-info');
            let html = '<strong>Teste de Conexão Supabase:</strong><br>';
            
            try {
                if (typeof supabase === 'undefined') {
                    throw new Error('Supabase manager não disponível');
                }
                
                html += '⏳ Testando conexão...<br>';
                supabaseDiv.innerHTML = html;
                
                // Testar busca de usuários
                const users = await supabase.request('users?select=email,plan,admin&limit=5');
                
                html += `✅ Conexão OK!<br>`;
                html += `📊 Usuários encontrados: ${users.length}<br>`;
                
                if (users.length > 0) {
                    html += `<br><strong>Primeiros usuários:</strong><br>`;
                    users.forEach(user => {
                        html += `• ${user.email} (${user.plan || 'starter'}) ${user.admin ? '👑' : ''}<br>`;
                    });
                }
                
                supabaseDiv.innerHTML = html;
                document.getElementById('supabase-test').className = 'debug-section success';
                
            } catch (error) {
                html += `❌ <strong>Erro:</strong> ${error.message}<br>`;
                supabaseDiv.innerHTML = html;
                document.getElementById('supabase-test').className = 'debug-section error';
            }
        }

        // Tentar acessar admin
        function tryAccessAdmin() {
            const accessDiv = document.getElementById('access-info');
            
            try {
                // Simular a verificação que o admin faria
                let user = null;
                try {
                    const sessionData = sessionStorage.getItem('currentUser');
                    if (sessionData) {
                        user = JSON.parse(sessionData);
                    }
                } catch (e) {}
                
                if (!user && typeof supabase !== 'undefined') {
                    user = supabase.currentUser;
                }
                
                if (!user) {
                    accessDiv.innerHTML = '❌ Nenhum usuário logado';
                    document.getElementById('admin-access').className = 'debug-section error';
                    return;
                }
                
                const isUserAdmin = user.admin === true || user.tipo === 'admin';
                const adminEmails = ['admin@teste.com', 'admin@extintores.com'];
                const isInAdminList = adminEmails.includes(user.email);
                const isDev = window.location.hostname.includes('localhost') || 
                             window.location.hostname.includes('127.0.0.1') ||
                             window.location.hostname.includes('netlify');
                
                const canAccess = isUserAdmin || isInAdminList || (isDev && user.email);
                
                if (canAccess) {
                    accessDiv.innerHTML = '✅ Acesso autorizado! Redirecionando...';
                    document.getElementById('admin-access').className = 'debug-section success';
                    
                    setTimeout(() => {
                        window.location.href = 'admin/index.html';
                    }, 1000);
                } else {
                    accessDiv.innerHTML = '❌ Acesso negado! Usuário não é admin';
                    document.getElementById('admin-access').className = 'debug-section error';
                }
                
            } catch (error) {
                accessDiv.innerHTML = `❌ Erro: ${error.message}`;
                document.getElementById('admin-access').className = 'debug-section error';
            }
        }

        // Inicializar página
        document.addEventListener('DOMContentLoaded', () => {
            checkDependencies();
            checkCurrentUser();
            
            // Se já estiver logado, habilitar botão admin
            const sessionUser = sessionStorage.getItem('currentUser');
            if (sessionUser) {
                document.getElementById('admin-btn').disabled = false;
                setTimeout(checkAdminStatus, 500);
            }
        });
    </script>
</body>
</html>
