<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Login Admin</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: #f5f5f5;
        }
        .debug-section {
            background: white;
            padding: 1.5rem;
            margin: 1rem 0;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .success { border-left: 4px solid #4caf50; }
        .error { border-left: 4px solid #f44336; }
        .warning { border-left: 4px solid #ff9800; }
        .info { border-left: 4px solid #2196f3; }
        pre { 
            background: #f0f0f0; 
            padding: 1rem; 
            border-radius: 4px; 
            overflow-x: auto; 
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin: 0.5rem 0;
        }
        button:hover { background: #0056b3; }
        input { 
            padding: 0.5rem; 
            margin: 0.5rem; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            width: 200px;
        }
        .login-form {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ” Debug Sistema Login Admin</h1>

    <div class="debug-section info">
        <h3>â„¹ï¸ InformaÃ§Ãµes do Sistema</h3>
        <p>Esta pÃ¡gina ajuda a debugar problemas de login no painel admin.</p>
        <p><strong>UsuÃ¡rio Admin de Teste:</strong> admin@teste.com | Senha: admin123</p>
    </div>

    <div class="debug-section" id="dependencies">
        <h3>ğŸ“¦ DependÃªncias</h3>
        <div id="deps-info">Carregando...</div>
        <button onclick="checkDependencies()">ğŸ” Verificar DependÃªncias</button>
    </div>

    <div class="debug-section" id="current-user">
        <h3>ğŸ‘¤ UsuÃ¡rio Atual</h3>
        <div id="user-info">Carregando...</div>
        <button onclick="checkCurrentUser()">ğŸ” Verificar UsuÃ¡rio</button>
    </div>

    <div class="debug-section" id="login-section">
        <h3>ğŸ” Teste de Login</h3>
        <div class="login-form">
            <input type="email" id="login-email" placeholder="Email" value="admin@teste.com">
            <input type="password" id="login-password" placeholder="Senha" value="admin123">
            <button onclick="testLogin()">ğŸ” Fazer Login</button>
        </div>
        <div id="login-result">FaÃ§a login para testar</div>
    </div>

    <div class="debug-section" id="admin-check">
        <h3>ğŸ‘‘ VerificaÃ§Ã£o Admin</h3>
        <div id="admin-info">Execute a verificaÃ§Ã£o</div>
        <button onclick="checkAdminStatus()">ğŸ‘‘ Verificar Status Admin</button>
    </div>

    <div class="debug-section" id="supabase-test">
        <h3>ğŸ—„ï¸ Teste Supabase</h3>
        <div id="supabase-info">Execute o teste</div>
        <button onclick="testSupabase()">ğŸ—„ï¸ Testar ConexÃ£o</button>
    </div>

    <div class="debug-section" id="admin-access">
        <h3>ğŸ›ï¸ Acesso ao Admin</h3>
        <div id="access-info">FaÃ§a login primeiro</div>
        <button onclick="tryAccessAdmin()" id="admin-btn" disabled>ğŸ›ï¸ Tentar Acessar Admin</button>
    </div>

    <script src="js/supabase-config.js"></script>
    <script>
        // Verificar dependÃªncias
        function checkDependencies() {
            const depsDiv = document.getElementById('deps-info');
            let html = '<strong>Status das DependÃªncias:</strong><br>';
            
            const checks = [
                { name: 'window.supabase', available: typeof window.supabase !== 'undefined' },
                { name: 'supabase (manager)', available: typeof supabase !== 'undefined' },
                { name: 'PlanValidator', available: typeof PlanValidator !== 'undefined' },
                { name: 'isAdmin function', available: typeof isAdmin === 'function' },
                { name: 'navigateToAdmin function', available: typeof navigateToAdmin === 'function' }
            ];
            
            checks.forEach(check => {
                const status = check.available ? 'âœ…' : 'âŒ';
                html += `${status} ${check.name}: ${check.available}<br>`;
            });
            
            depsDiv.innerHTML = html;
            document.getElementById('dependencies').className = 'debug-section ' + 
                (checks.every(c => c.available) ? 'success' : 'warning');
        }

        // Verificar usuÃ¡rio atual
        function checkCurrentUser() {
            const userDiv = document.getElementById('user-info');
            let html = '<strong>Status do UsuÃ¡rio:</strong><br>';
            
            // Verificar sessionStorage
            let sessionUser = null;
            try {
                const sessionData = sessionStorage.getItem('currentUser');
                if (sessionData) {
                    sessionUser = JSON.parse(sessionData);
                }
            } catch (e) {}
            
            // Verificar supabase manager
            let supabaseUser = null;
            if (typeof supabase !== 'undefined') {
                supabaseUser = supabase.currentUser;
            }
            
            html += `ğŸ“ sessionStorage: ${sessionUser ? 'âœ… ' + sessionUser.email : 'âŒ Vazio'}<br>`;
            html += `ğŸ”§ supabase.currentUser: ${supabaseUser ? 'âœ… ' + supabaseUser.email : 'âŒ Vazio'}<br>`;
            
            if (sessionUser) {
                html += `<br><strong>Dados sessionStorage:</strong><br>`;
                html += `<pre>${JSON.stringify(sessionUser, null, 2)}</pre>`;
            }
            
            userDiv.innerHTML = html;
            document.getElementById('current-user').className = 'debug-section ' + 
                (sessionUser || supabaseUser ? 'success' : 'error');
        }

        // Teste de login
        async function testLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const resultDiv = document.getElementById('login-result');
            
            try {
                resultDiv.innerHTML = 'â³ Fazendo login...';
                
                if (typeof supabase === 'undefined') {
                    throw new Error('Supabase manager nÃ£o disponÃ­vel');
                }
                
                const result = await supabase.login(email, password);
                
                if (result) {
                    resultDiv.innerHTML = 'âœ… <strong>Login realizado com sucesso!</strong>';
                    document.getElementById('login-section').className = 'debug-section success';
                    document.getElementById('admin-btn').disabled = false;
                    
                    // Atualizar outros testes
                    setTimeout(() => {
                        checkCurrentUser();
                        checkAdminStatus();
                    }, 500);
                } else {
                    resultDiv.innerHTML = 'âŒ <strong>Falha no login</strong> - Credenciais invÃ¡lidas ou usuÃ¡rio nÃ£o existe';
                    document.getElementById('login-section').className = 'debug-section error';
                }
            } catch (error) {
                resultDiv.innerHTML = `âŒ <strong>Erro no login:</strong> ${error.message}`;
                document.getElementById('login-section').className = 'debug-section error';
            }
        }

        // Verificar status admin
        function checkAdminStatus() {
            const adminDiv = document.getElementById('admin-info');
            let html = '<strong>VerificaÃ§Ã£o de Admin:</strong><br>';
            
            // Pegar usuÃ¡rio atual
            let user = null;
            try {
                const sessionData = sessionStorage.getItem('currentUser');
                if (sessionData) {
                    user = JSON.parse(sessionData);
                }
            } catch (e) {}
            
            if (!user && typeof supabase !== 'undefined') {
                user = supabase.currentUser;
            }
            
            if (!user) {
                html += 'âŒ Nenhum usuÃ¡rio logado<br>';
                adminDiv.innerHTML = html;
                document.getElementById('admin-check').className = 'debug-section error';
                return;
            }
            
            html += `ğŸ‘¤ UsuÃ¡rio: ${user.email}<br>`;
            html += `ğŸ”‘ user.admin: ${user.admin}<br>`;
            html += `ğŸ·ï¸ user.tipo: ${user.tipo}<br>`;
            html += `ğŸ“¦ user.plan: ${user.plan}<br>`;
            
            // Verificar se Ã© admin
            const isUserAdmin = user.admin === true || user.tipo === 'admin';
            const adminEmails = ['admin@teste.com', 'admin@extintores.com'];
            const isInAdminList = adminEmails.includes(user.email);
            const isDev = window.location.hostname.includes('localhost') || 
                         window.location.hostname.includes('127.0.0.1') ||
                         window.location.hostname.includes('netlify');
            
            html += `<br><strong>VerificaÃ§Ãµes:</strong><br>`;
            html += `âœ”ï¸ user.admin === true: ${user.admin === true}<br>`;
            html += `âœ”ï¸ user.tipo === 'admin': ${user.tipo === 'admin'}<br>`;
            html += `âœ”ï¸ Email na lista admin: ${isInAdminList}<br>`;
            html += `âœ”ï¸ Modo desenvolvimento: ${isDev}<br>`;
            
            const finalAdminStatus = isUserAdmin || isInAdminList || (isDev && user.email);
            html += `<br><strong>ğŸ¯ RESULTADO FINAL: ${finalAdminStatus ? 'âœ… Ã‰ ADMIN' : 'âŒ NÃƒO Ã‰ ADMIN'}</strong>`;
            
            adminDiv.innerHTML = html;
            document.getElementById('admin-check').className = 'debug-section ' + 
                (finalAdminStatus ? 'success' : 'error');
        }

        // Testar Supabase
        async function testSupabase() {
            const supabaseDiv = document.getElementById('supabase-info');
            let html = '<strong>Teste de ConexÃ£o Supabase:</strong><br>';
            
            try {
                if (typeof supabase === 'undefined') {
                    throw new Error('Supabase manager nÃ£o disponÃ­vel');
                }
                
                html += 'â³ Testando conexÃ£o...<br>';
                supabaseDiv.innerHTML = html;
                
                // Testar busca de usuÃ¡rios
                const users = await supabase.request('users?select=email,plan,admin&limit=5');
                
                html += `âœ… ConexÃ£o OK!<br>`;
                html += `ğŸ“Š UsuÃ¡rios encontrados: ${users.length}<br>`;
                
                if (users.length > 0) {
                    html += `<br><strong>Primeiros usuÃ¡rios:</strong><br>`;
                    users.forEach(user => {
                        html += `â€¢ ${user.email} (${user.plan || 'starter'}) ${user.admin ? 'ğŸ‘‘' : ''}<br>`;
                    });
                }
                
                supabaseDiv.innerHTML = html;
                document.getElementById('supabase-test').className = 'debug-section success';
                
            } catch (error) {
                html += `âŒ <strong>Erro:</strong> ${error.message}<br>`;
                supabaseDiv.innerHTML = html;
                document.getElementById('supabase-test').className = 'debug-section error';
            }
        }

        // Tentar acessar admin
        function tryAccessAdmin() {
            const accessDiv = document.getElementById('access-info');
            
            try {
                // Simular a verificaÃ§Ã£o que o admin faria
                let user = null;
                try {
                    const sessionData = sessionStorage.getItem('currentUser');
                    if (sessionData) {
                        user = JSON.parse(sessionData);
                    }
                } catch (e) {}
                
                if (!user && typeof supabase !== 'undefined') {
                    user = supabase.currentUser;
                }
                
                if (!user) {
                    accessDiv.innerHTML = 'âŒ Nenhum usuÃ¡rio logado';
                    document.getElementById('admin-access').className = 'debug-section error';
                    return;
                }
                
                const isUserAdmin = user.admin === true || user.tipo === 'admin';
                const adminEmails = ['admin@teste.com', 'admin@extintores.com'];
                const isInAdminList = adminEmails.includes(user.email);
                const isDev = window.location.hostname.includes('localhost') || 
                             window.location.hostname.includes('127.0.0.1') ||
                             window.location.hostname.includes('netlify');
                
                const canAccess = isUserAdmin || isInAdminList || (isDev && user.email);
                
                if (canAccess) {
                    accessDiv.innerHTML = 'âœ… Acesso autorizado! Redirecionando...';
                    document.getElementById('admin-access').className = 'debug-section success';
                    
                    setTimeout(() => {
                        window.location.href = 'admin/index.html';
                    }, 1000);
                } else {
                    accessDiv.innerHTML = 'âŒ Acesso negado! UsuÃ¡rio nÃ£o Ã© admin';
                    document.getElementById('admin-access').className = 'debug-section error';
                }
                
            } catch (error) {
                accessDiv.innerHTML = `âŒ Erro: ${error.message}`;
                document.getElementById('admin-access').className = 'debug-section error';
            }
        }

        // Inicializar pÃ¡gina
        document.addEventListener('DOMContentLoaded', () => {
            checkDependencies();
            checkCurrentUser();
            
            // Se jÃ¡ estiver logado, habilitar botÃ£o admin
            const sessionUser = sessionStorage.getItem('currentUser');
            if (sessionUser) {
                document.getElementById('admin-btn').disabled = false;
                setTimeout(checkAdminStatus, 500);
            }
        });
    </script>
</body>
</html>
