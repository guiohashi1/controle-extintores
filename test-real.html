<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî• Teste Real - Cria√ß√£o de Extintores</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/plan-styles.css">
    <style>
        body {
            padding: 20px;
            background: #f8f9fa;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .user-selector {
            background: #e9ecef;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .current-user {
            background: #d4edda;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #28a745;
        }
        .extinction-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .btn {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn.danger {
            background: #dc3545;
        }
        .btn.success {
            background: #28a745;
        }
        .results {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
        }
        .log-success { color: #2ecc71; }
        .log-error { color: #e74c3c; }
        .log-warning { color: #f39c12; }
        .log-info { color: #3498db; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üî• Teste Real - Limita√ß√µes de Planos</h1>
        <p>Este teste ir√° realmente tentar criar extintores e validar as limita√ß√µes</p>
        
        <!-- Seletor de usu√°rio -->
        <div class="user-selector">
            <h3>üë§ Selecionar Usu√°rio de Teste</h3>
            <button class="btn" onclick="loginTestUser('starter')">Login Starter (45/50)</button>
            <button class="btn" onclick="loginTestUser('professional')">Login Professional (150/200)</button>
            <button class="btn" onclick="loginTestUser('enterprise')">Login Enterprise (300/‚àû)</button>
            <button class="btn danger" onclick="loginTestUser('expired')">Login Vencido</button>
        </div>
        
        <div id="current-user-info" class="current-user" style="display: none;">
            <h4>Usu√°rio Atual:</h4>
            <div id="user-details"></div>
        </div>
        
        <!-- Formul√°rio de extintor -->
        <div class="extinction-form">
            <h3>üßØ Criar Novo Extintor</h3>
            <form id="extintor-form">
                <div class="form-group">
                    <label for="numero">N√∫mero:</label>
                    <input type="text" id="numero" required>
                </div>
                <div class="form-group">
                    <label for="local">Local:</label>
                    <input type="text" id="local" required>
                </div>
                <div class="form-group">
                    <label for="tipo">Tipo:</label>
                    <select id="tipo" required>
                        <option value="">Selecione o tipo</option>
                        <option value="P√≥ Qu√≠mico Seco">P√≥ Qu√≠mico Seco</option>
                        <option value="CO2">CO2</option>
                        <option value="Espuma Mec√¢nica">Espuma Mec√¢nica</option>
                        <option value="√Ågua Pressurizada">√Ågua Pressurizada</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="peso">Peso (kg):</label>
                    <input type="number" id="peso" step="0.1" required>
                </div>
                <div class="form-group">
                    <label for="validade">Data de Validade:</label>
                    <input type="date" id="validade" required>
                </div>
                
                <button type="submit" class="btn success">Criar Extintor</button>
            </form>
        </div>
        
        <!-- Testes automatizados -->
        <div class="user-selector">
            <h3>ü§ñ Testes Automatizados</h3>
            <button class="btn" onclick="testAllPlans()">Testar Todos os Planos</button>
            <button class="btn" onclick="testLimitReached()">Testar Limite Atingido</button>
            <button class="btn" onclick="testPhotoUpload()">Testar Upload de Fotos</button>
            <button class="btn" onclick="testExportFormats()">Testar Exporta√ß√£o</button>
            <button class="btn danger" onclick="clearResults()">Limpar Resultados</button>
        </div>
        
        <!-- Resultados -->
        <div class="results" id="results">
            <div class="log-info">[Sistema] Carregando testes...</div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/common.js"></script>
    <script src="js/plan-validator.js"></script>

    <script>
        // Usu√°rios de teste
        const testUsers = {
            starter: {
                id: 'test-starter-001',
                email: 'starter@test-plans.com',
                name: 'Empresa Starter Teste',
                plan: 'starter',
                plan_status: 'active',
                plan_expires_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
            },
            professional: {
                id: 'test-professional-001',
                email: 'professional@test-plans.com',
                name: 'Empresa Professional Teste',
                plan: 'professional',
                plan_status: 'active',
                plan_expires_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
            },
            enterprise: {
                id: 'test-enterprise-001',
                email: 'enterprise@test-plans.com',
                name: 'Empresa Enterprise Teste',
                plan: 'enterprise',
                plan_status: 'active',
                plan_expires_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
            },
            expired: {
                id: 'test-expired-001',
                email: 'expired@test-plans.com',
                name: 'Empresa Vencida Teste',
                plan: 'professional',
                plan_status: 'expired',
                plan_expires_at: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString()
            }
        };

        let currentUser = null;
        const results = document.getElementById('results');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = `log-${type}`;
            const logEntry = `<div class="${className}">[${timestamp}] ${message}</div>`;
            results.innerHTML += logEntry;
            results.scrollTop = results.scrollHeight;
        }

        function clearResults() {
            results.innerHTML = '<div class="log-info">[Sistema] Resultados limpos</div>';
        }

        // Login com usu√°rio de teste
        function loginTestUser(userType) {
            const user = testUsers[userType];
            if (!user) {
                log(`Usu√°rio ${userType} n√£o encontrado`, 'error');
                return;
            }

            currentUser = user;
            sessionStorage.setItem('currentUser', JSON.stringify(user));
            
            // Inicializar validador de planos
            if (window.PlanValidator) {
                const isValid = PlanValidator.initialize(user);
                log(`Login realizado: ${user.name} (${user.plan}) - Status: ${isValid ? 'Ativo' : 'Inativo'}`, 'success');
            } else {
                log(`Login simulado: ${user.name}`, 'warning');
            }

            // Atualizar interface
            const userInfo = document.getElementById('current-user-info');
            const userDetails = document.getElementById('user-details');
            userInfo.style.display = 'block';
            userDetails.innerHTML = `
                <strong>${user.name}</strong><br>
                Plano: ${user.plan}<br>
                Status: ${user.plan_status}<br>
                Email: ${user.email}
            `;

            // Preencher formul√°rio com dados aleat√≥rios
            document.getElementById('numero').value = 'EXT-TEST-' + Math.floor(Math.random() * 1000);
            document.getElementById('local').value = 'Local Teste ' + Math.floor(Math.random() * 100);
            document.getElementById('tipo').value = 'P√≥ Qu√≠mico Seco';
            document.getElementById('peso').value = '4.0';
            document.getElementById('validade').value = new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        }

        // Handler do formul√°rio
        document.getElementById('extintor-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentUser) {
                log('Nenhum usu√°rio logado. Fa√ßa login primeiro.', 'error');
                return;
            }

            log(`Tentando criar extintor para ${currentUser.name}...`, 'info');

            // Verificar limita√ß√£o do plano
            if (window.PlanValidator) {
                try {
                    const canCreate = await PlanValidator.canCreateExtintor();
                    
                    if (!canCreate) {
                        log(`‚ùå Cria√ß√£o bloqueada pelo sistema de planos`, 'error');
                        return;
                    }
                    
                    log(`‚úÖ Valida√ß√£o de plano aprovada`, 'success');
                    
                    // Simular cria√ß√£o (aqui voc√™ faria a chamada real para o Supabase)
                    const extintorData = {
                        numero: document.getElementById('numero').value,
                        local: document.getElementById('local').value,
                        tipo: document.getElementById('tipo').value,
                        peso: document.getElementById('peso').value,
                        validade: document.getElementById('validade').value,
                        user_id: currentUser.id
                    };
                    
                    log(`‚úÖ Extintor criado com sucesso: ${extintorData.numero}`, 'success');
                    log(`üìç Local: ${extintorData.local}`, 'info');
                    
                    // Limpar formul√°rio
                    document.getElementById('extintor-form').reset();
                    
                } catch (error) {
                    log(`‚ùå Erro na valida√ß√£o: ${error.message}`, 'error');
                }
            } else {
                log('PlanValidator n√£o dispon√≠vel - criando extintor sem valida√ß√£o', 'warning');
            }
        });

        // Testar todos os planos
        async function testAllPlans() {
            log('üß™ Iniciando teste de todos os planos...', 'info');
            
            for (const planType of Object.keys(testUsers)) {
                loginTestUser(planType);
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                if (window.PlanValidator) {
                    const canCreate = await PlanValidator.canCreateExtintor();
                    const canPhotos = PlanValidator.canUsePhotos();
                    const canExportPDF = PlanValidator.canExport('pdf');
                    const canExportExcel = PlanValidator.canExport('excel');
                    
                    log(`${planType.toUpperCase()}: Criar extintor: ${canCreate ? '‚úÖ' : '‚ùå'}`, canCreate ? 'success' : 'error');
                    log(`${planType.toUpperCase()}: Fotos: ${canPhotos ? '‚úÖ' : '‚ùå'}`, canPhotos ? 'success' : 'info');
                    log(`${planType.toUpperCase()}: Export PDF: ${canExportPDF ? '‚úÖ' : '‚ùå'}`, canExportPDF ? 'success' : 'info');
                    log(`${planType.toUpperCase()}: Export Excel: ${canExportExcel ? '‚úÖ' : '‚ùå'}`, canExportExcel ? 'success' : 'info');
                }
                
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            log('üèÅ Teste completo finalizado', 'success');
        }

        // Testar limite atingido
        async function testLimitReached() {
            log('‚ö†Ô∏è Testando comportamento quando limite √© atingido...', 'info');
            
            // Login como starter (que tem 45/50 extintores)
            loginTestUser('starter');
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Tentar criar 6 extintores (deve bloquear ap√≥s 5)
            for (let i = 1; i <= 6; i++) {
                log(`Tentativa ${i}/6 de criar extintor...`, 'info');
                
                if (window.PlanValidator) {
                    const canCreate = await PlanValidator.canCreateExtintor();
                    
                    if (canCreate) {
                        log(`‚úÖ Extintor ${i} criado`, 'success');
                    } else {
                        log(`‚ùå Extintor ${i} bloqueado (limite atingido)`, 'error');
                        break;
                    }
                }
                
                await new Promise(resolve => setTimeout(resolve, 300));
            }
        }

        // Testar upload de fotos
        async function testPhotoUpload() {
            log('üì∑ Testando funcionalidade de fotos...', 'info');
            
            const plansToTest = ['starter', 'professional', 'enterprise'];
            
            for (const planType of plansToTest) {
                loginTestUser(planType);
                await new Promise(resolve => setTimeout(resolve, 500));
                
                if (window.PlanValidator) {
                    const canUsePhotos = PlanValidator.canUsePhotos();
                    const expected = planType !== 'starter';
                    
                    if (canUsePhotos === expected) {
                        log(`‚úÖ ${planType.toUpperCase()}: Fotos ${canUsePhotos ? 'permitidas' : 'bloqueadas'} corretamente`, 'success');
                    } else {
                        log(`‚ùå ${planType.toUpperCase()}: Erro na valida√ß√£o de fotos`, 'error');
                    }
                }
            }
        }

        // Testar formatos de exporta√ß√£o
        async function testExportFormats() {
            log('üìä Testando formatos de exporta√ß√£o...', 'info');
            
            const formats = ['pdf', 'excel', 'csv'];
            const plans = ['starter', 'professional', 'enterprise'];
            
            for (const planType of plans) {
                loginTestUser(planType);
                await new Promise(resolve => setTimeout(resolve, 300));
                
                for (const format of formats) {
                    if (window.PlanValidator) {
                        const canExport = PlanValidator.canExport(format);
                        log(`${planType.toUpperCase()} - ${format.toUpperCase()}: ${canExport ? '‚úÖ' : '‚ùå'}`, canExport ? 'success' : 'info');
                    }
                }
            }
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            log('üéØ Sistema de teste real carregado!', 'success');
            
            if (typeof PlanValidator !== 'undefined') {
                log('‚úÖ PlanValidator carregado com sucesso', 'success');
                log('üìã Planos dispon√≠veis: ' + Object.keys(PlanValidator.PLANS).join(', '), 'info');
            } else {
                log('‚ö†Ô∏è PlanValidator n√£o foi carregado', 'warning');
            }
        });
    </script>
</body>
</html>
