<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#121212">
    <title>Cadastro de Extint            // üö® PROTE√á√ÉO DE EMERG√äNCIA ANTICACHE - V5.3 SESSION STORAGE FIX
            // Esta valida√ß√£o funciona SEMPRE, mesmo com cache!
            // üîß CORRE√á√ÉO: Usa sessionStorage diretamente para evitar depend√™ncias
            // üïí TIMESTAMP: 1754673400 - FORCE UPDATE
            if (editandoIndex === null) {
                console.log('üö® PROTE√á√ÉO EMERG√äNCIA V5.3 - Validando INLINE (SESSION STORAGE)...'); Controle de Extintores</title>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/common.js"></script>
    <script src="../js/plan-validator.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/navigation.css">
    <link rel="stylesheet" href="../css/plan-styles.css">
    <link rel="stylesheet" href="../css/pwa.css">
</head>
<body>
    <!-- Navigation Bar -->
    <div id="navbar-container"></div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="screen-header">
            <h1 id="formTitle">Novo Extintor</h1>
            <p>Cadastre ou edite um extintor</p>
        </div>
        
        <div class="card">
            <form id="form">
                <div class="form-group">
                    <label for="numero">N√∫mero do Extintor *</label>
                    <input type="text" id="numero" placeholder="Ex: EXT-001" required />
                    <small class="form-help">Identifica√ß√£o √∫nica do extintor</small>
                </div>
                
                <div class="form-group">
                    <label for="local">Local *</label>
                    <input type="text" id="local" placeholder="Ex: Se√ß√£o de Faturamento" required />
                    <small class="form-help">Localiza√ß√£o onde o extintor est√° instalado</small>
                </div>
                
                <div class="form-group">
                    <label for="tipo">Tipo do Extintor *</label>
                    <select id="tipo" required>
                        <option value="" disabled selected>Selecione o tipo</option>
                        <option value="√Ågua">√Ågua</option>
                        <option value="CO2">CO2</option>
                        <option value="P√≥ Qu√≠mico">P√≥ Qu√≠mico</option>
                        <option value="Espuma">Espuma</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="peso">Peso (kg) *</label>
                    <input type="number" id="peso" placeholder="Ex: 6" step="0.1" min="0" required />
                    <small class="form-help">Peso do extintor em quilogramas</small>
                </div>
                
                <div class="form-group">
                    <label for="validade">Data de Validade *</label>
                    <input type="date" id="validade" required />
                    <small class="form-help">Data de vencimento do extintor</small>
                </div>
                
                <div class="form-group">
                    <label for="hidro">Data do Teste Hidrost√°tico *</label>
                    <input type="date" id="hidro" required />
                    <small class="form-help">Data do √∫ltimo teste hidrost√°tico realizado</small>
                </div>
                
                <div class="form-group">
                    <label for="observacoes">Observa√ß√µes</label>
                    <textarea id="observacoes" rows="3" placeholder="Observa√ß√µes adicionais (opcional)"></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20,6 9,17 4,12"></polyline>
                        </svg>
                        Salvar Extintor
                    </button>
                    <a href="extintores.html" class="btn btn-secondary">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="m12 19-7-7 7-7"></path>
                            <path d="m19 12-7 7-7-7"></path>
                        </svg>
                        Cancelar
                    </a>
                </div>
            </form>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <div id="bottom-nav-container"></div>

    <script>
        let editandoIndex = null;
        let editandoData = null;

        // Inicializa√ß√£o da p√°gina
        document.addEventListener('DOMContentLoaded', async () => {
            // Verificar se usu√°rio est√° logado
            if (!checkAuth()) return;
            
            // üîí PROTE√á√ÉO DEFINITIVA DE PLANOS - V3.0 FINAL
            // Validar limites SEMPRE que a p√°gina carregar (exceto para edi√ß√£o)
            const editandoExtintor = sessionStorage.getItem('editandoExtintor');
            if (!editandoExtintor && window.PlanValidator) {
                console.log('üõ°Ô∏è PROTE√á√ÉO FORM V3.0 - Validando limites...');
                
                try {
                    // Inicializar o validador primeiro
                    const currentUser = getCurrentUser();
                    if (currentUser && !PlanValidator.initialize(currentUser)) {
                        return; // Plano vencido/inativo
                    }
                    
                    const canCreate = await PlanValidator.canCreateExtintor();
                    if (!canCreate) {
                        console.log('üö´ ACESSO NEGADO - Limite atingido, redirecionando...');
                        // Aguardar 1 segundo para o modal aparecer, depois redirecionar
                        setTimeout(() => {
                            window.location.href = 'extintores.html';
                        }, 1000);
                        return;
                    }
                    console.log('‚úÖ ACESSO LIBERADO - Pode criar extintor');
                } catch (error) {
                    console.error('‚ùå Erro na prote√ß√£o de planos:', error);
                    // Em caso de erro, permitir acesso para n√£o travar o sistema
                }
            }
            
            // Carregar componentes
            await loadNavbarComponent();
            await loadBottomNavComponent();
            setActiveNavItem('form');
            
            // Verificar se est√° editando
            verificarEdicao();
        });

        function verificarEdicao() {
            const editandoExtintor = sessionStorage.getItem('editandoExtintor');
            
            if (editandoExtintor) {
                const dados = JSON.parse(editandoExtintor);
                editandoIndex = dados.index;
                editandoData = dados.data;
                
                // Atualizar t√≠tulo
                document.getElementById('formTitle').textContent = 'Editar Extintor';
                
                // Preencher formul√°rio
                document.getElementById('numero').value = editandoData.numero || '';
                document.getElementById('local').value = editandoData.local || '';
                document.getElementById('tipo').value = editandoData.tipo || '';
                document.getElementById('peso').value = editandoData.peso || '';
                document.getElementById('validade').value = editandoData.validade || '';
                document.getElementById('hidro').value = editandoData.hidro || '';
                document.getElementById('observacoes').value = editandoData.observacoes || '';
                
                // Limpar sessionStorage
                sessionStorage.removeItem('editandoExtintor');
            }
        }

        async function validarFormulario() {
            const numero = document.getElementById('numero').value.trim();
            const local = document.getElementById('local').value.trim();
            const tipo = document.getElementById('tipo').value;
            const peso = document.getElementById('peso').value;
            const validade = document.getElementById('validade').value;
            const hidro = document.getElementById('hidro').value;

            // Valida√ß√£o b√°sica
            if (!numero || !local || !tipo || !peso || !validade || !hidro) {
                showNotification('Por favor, preencha todos os campos obrigat√≥rios.', 'error');
                return false;
            }

            // Verificar duplicatas (s√≥ se n√£o estiver editando)
            if (editandoIndex === null) {
                const extintores = await carregarExtintores();
                const numeroExistente = extintores.find(ext => ext.numero === numero);
                
                if (numeroExistente) {
                    showNotification('J√° existe um extintor com este n√∫mero.', 'error');
                    return false;
                }
            }

            // Valida√ß√£o de datas
            const dataValidade = new Date(validade);
            const dataHidro = new Date(hidro);
            const hoje = new Date();
            
            if (dataValidade <= hoje) {
                showNotification('A data de validade deve ser futura.', 'warning');
            }
            
            if (dataHidro > hoje) {
                showNotification('A data do teste hidrost√°tico n√£o pode ser futura.', 'error');
                return false;
            }

            // Valida√ß√£o de peso
            if (parseFloat(peso) <= 0) {
                showNotification('O peso deve ser maior que zero.', 'error');
                return false;
            }

            return true;
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            
            if (!(await validarFormulario())) {
                return;
            }
            
            // ÔøΩ PROTE√á√ÉO DE EMERG√äNCIA ANTICACHE - V5.0 ABSOLUTA
            // Esta valida√ß√£o funciona SEMPRE, mesmo com cache!
            if (editandoIndex === null) {
                console.log('üö® PROTE√á√ÉO EMERG√äNCIA V5.0 - Validando INLINE...');
                
                try {
                    // üîß CORRE√á√ÉO: Buscar usu√°rio diretamente do sessionStorage
                    const userDataString = sessionStorage.getItem('currentUser');
                    console.log('üîç DEBUG: sessionStorage currentUser:', userDataString);
                    
                    if (!userDataString) {
                        console.error('‚ùå EMERG√äNCIA: Nenhum usu√°rio no sessionStorage');
                        showNotification('Erro: usu√°rio n√£o autenticado.', 'error');
                        return;
                    }
                    
                    const currentUser = JSON.parse(userDataString);
                    console.log('üîç DEBUG: Parsed user object:', currentUser);
                    console.log('üîç DEBUG: id field:', currentUser.id);
                    console.log('üîç DEBUG: user_id field:', currentUser.user_id);
                    
                    if (!currentUser || !currentUser.id) {
                        console.error('‚ùå EMERG√äNCIA: id n√£o encontrado');
                        console.error('üìã DEBUG: Objeto usuario completo:', currentUser);
                        showNotification('Erro: dados de usu√°rio inv√°lidos.', 'error');
                        return;
                    }
                    
                    console.log('üë§ EMERG√äNCIA: Validando para usu√°rio:', currentUser.id);
                    
                    // Buscar contagem diretamente do usu√°rio correto
                    const response = await fetch(`https://japgbufsqbjfkbkrncgg.supabase.co/rest/v1/extintores?user_id=eq.${currentUser.id}&select=*`, {
                        headers: {
                            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImphcGdidWZzcWJqZmtia3JuY2dnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0OTg3NTksImV4cCI6MjA3MDA3NDc1OX0.AIc0koiJoLrRoFEhvV8qfskpL5ffA-l35cvGNGTLlOs',
                            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImphcGdidWZzcWJqZmtia3JuY2dnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0OTg3NTksImV4cCI6MjA3MDA3NDc1OX0.AIc0koiJoLrRoFEhvV8qfskpL5ffA-l35cvGNGTLlOs'
                        }
                    });
                    
                    const extintores = await response.json();
                    const count = Array.isArray(extintores) ? extintores.length : 0;
                    
                    console.log('üìä Contagem CORRIGIDA (usu√°rio correto):', count);
                    console.log('üî¢ Limite Starter:', 50);
                    
                    if (count >= 50) {
                        console.log('üö´ BLOQUEADO PELA PROTE√á√ÉO DE EMERG√äNCIA!');
                        
                        // Modal de emerg√™ncia com estilo profissional
                        const modal = document.createElement('div');
                        modal.className = 'emergency-modal-overlay';
                        modal.innerHTML = `
                            <div class="emergency-modal-content">
                                <h3>üö´ Limite do Plano Atingido</h3>
                                <p>Seu plano <strong>Starter</strong> permite at√© <strong>50 extintores</strong>.</p>
                                <p>Voc√™ j√° tem <strong>${count} extintores</strong> cadastrados.</p>
                                <p>Para cadastrar mais extintores, fa√ßa upgrade para o plano <strong>Professional</strong> (200 extintores) por apenas <strong>R$ 197/m√™s</strong>.</p>
                                <button class="emergency-btn" onclick="this.closest('.emergency-modal-overlay').remove(); window.location.href='extintores.html';">
                                    Voltar para Lista
                                </button>
                            </div>
                        `;
                        document.body.appendChild(modal);
                        return;
                    }
                    
                    console.log('‚úÖ EMERG√äNCIA: Pode criar extintor');
                } catch (error) {
                    console.error('‚ùå Erro na prote√ß√£o de emerg√™ncia:', error);
                    showNotification('Erro ao validar limites. Tente novamente.', 'error');
                    return;
                }
            }
            
            // ÔøΩüõ°Ô∏è PROTE√á√ÉO DUPLA NO SUBMIT - V3.0 FINAL
            // Validar limite do plano (apenas para novos extintores)
            if (editandoIndex === null && window.PlanValidator) {
                console.log('üõ°Ô∏è PROTE√á√ÉO SUBMIT - Validando limites antes de salvar...');
                
                try {
                    const canCreate = await PlanValidator.canCreateExtintor();
                    if (!canCreate) {
                        console.log('üö´ SUBMIT BLOQUEADO - Limite atingido');
                        return; // Modal de upgrade j√° foi exibido
                    }
                    console.log('‚úÖ SUBMIT LIBERADO - Pode criar extintor');
                } catch (error) {
                    console.error('‚ùå Erro na valida√ß√£o do submit:', error);
                    showNotification('Erro ao validar limites do plano. Tente novamente.', 'error');
                    return;
                }
            }
            
            const extintor = {
                numero: document.getElementById('numero').value.trim(),
                local: document.getElementById('local').value.trim(),
                tipo: document.getElementById('tipo').value,
                peso: parseFloat(document.getElementById('peso').value),
                validade: document.getElementById('validade').value,
                hidro: document.getElementById('hidro').value,
                observacoes: document.getElementById('observacoes').value.trim() || null
            };
            
            // Se estiver editando, incluir ID
            if (editandoData && editandoData.id) {
                extintor.id = editandoData.id;
            }
            
            try {
                const sucesso = await salvarExtintor(extintor);
                
                if (sucesso) {
                    const mensagem = editandoIndex !== null 
                        ? 'Extintor atualizado com sucesso!' 
                        : 'Extintor cadastrado com sucesso!';
                    
                    showNotification(mensagem);
                    
                    // Redirecionar para lista
                    setTimeout(() => {
                        window.location.href = 'extintores.html';
                    }, 1500);
                }
            } catch (error) {
                console.error('Erro ao salvar extintor:', error);
                showNotification('Erro ao salvar extintor. Tente novamente.', 'error');
            }
        }

        // Event listeners
        document.getElementById('form').addEventListener('submit', handleFormSubmit);

        // Definir data m√≠nima para o teste hidrost√°tico (n√£o pode ser futura)
        document.getElementById('hidro').max = new Date().toISOString().split('T')[0];
        
        // Definir data m√≠nima para validade (hoje)
        document.getElementById('validade').min = new Date().toISOString().split('T')[0];
    </script>

    <style>
        .form-help {
            display: block;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
            font-style: italic;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .form-actions .btn {
            flex: 1;
            min-width: 150px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        @media (max-width: 640px) {
            .form-actions {
                flex-direction: column;
            }
            
            .form-actions .btn {
                width: 100%;
            }
        }

        /* Adicionar indicador de campo obrigat√≥rio */
        .form-group label::after {
            content: "";
        }

        .form-group label[for="numero"]::after,
        .form-group label[for="local"]::after,
        .form-group label[for="tipo"]::after,
        .form-group label[for="peso"]::after,
        .form-group label[for="validade"]::after,
        .form-group label[for="hidro"]::after {
            content: " *";
            color: var(--danger-color);
        }

        /* Estilo para campos inv√°lidos */
        .form-group input:invalid,
        .form-group select:invalid {
            border-color: var(--danger-color);
        }

        .form-group input:valid,
        .form-group select:valid {
            border-color: var(--success-color);
        }
    </style>
    
    <!-- PWA Manager removido para teste sem cache -->
</body>
</html>
