<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#121212">
    <title>Cadastro de Extintor - Controle de Extintores</title>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/common.js"></script>
    <script src="../js/plan-validator.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/navigation.css">
    <link rel="stylesheet" href="../css/plan-styles.css">
    <link rel="stylesheet" href="../css/pwa.css">
</head>
<body>
    <!-- Navigation Bar -->
    <div id="navbar-container"></div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="screen-header">
            <h1 id="formTitle">Novo Extintor</h1>
            <p>Cadastre ou edite um extintor</p>
        </div>
        
        <div class="card">
            <form id="form">
                <div class="form-group">
                    <label for="numero">N√∫mero do Extintor *</label>
                    <input type="text" id="numero" placeholder="Ex: EXT-001" required />
                    <small class="form-help">Identifica√ß√£o √∫nica do extintor</small>
                </div>
                
                <div class="form-group">
                    <label for="local">Local *</label>
                    <input type="text" id="local" placeholder="Ex: Se√ß√£o de Faturamento" required />
                    <small class="form-help">Localiza√ß√£o onde o extintor est√° instalado</small>
                </div>
                
                <div class="form-group">
                    <label for="tipo">Tipo do Extintor *</label>
                    <select id="tipo" required>
                        <option value="" disabled selected>Selecione o tipo</option>
                        <option value="√Ågua">√Ågua</option>
                        <option value="CO2">CO2</option>
                        <option value="P√≥ Qu√≠mico">P√≥ Qu√≠mico</option>
                        <option value="Espuma">Espuma</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="peso">Peso (kg) *</label>
                    <input type="number" id="peso" placeholder="Ex: 6" step="0.1" min="0" required />
                    <small class="form-help">Peso do extintor em quilogramas</small>
                </div>
                
                <div class="form-group">
                    <label for="validade">Data de Validade *</label>
                    <input type="date" id="validade" required />
                    <small class="form-help">Data de vencimento do extintor</small>
                </div>
                
                <div class="form-group">
                    <label for="hidro">Data do Teste Hidrost√°tico *</label>
                    <input type="date" id="hidro" required />
                    <small class="form-help">Data do √∫ltimo teste hidrost√°tico realizado</small>
                </div>
                
                <div class="form-group">
                    <label for="observacoes">Observa√ß√µes</label>
                    <textarea id="observacoes" rows="3" placeholder="Observa√ß√µes adicionais (opcional)"></textarea>
                </div>
                
                <!-- Campo de Upload de Foto -->
                <div class="form-group" data-feature="photo-upload">
                    <label for="extintorPhoto">
                        üì∏ Foto do Extintor
                        <span class="plan-badge" data-plan="professional">‚≠ê PRO+</span>
                    </label>
                    <div class="photo-upload-container">
                        <input 
                            type="file" 
                            id="extintorPhoto" 
                            accept="image/*"
                            capture="environment"
                            style="display: none;"
                        >
                        <div class="photo-upload-zone" data-feature="photos" onclick="handlePhotoZoneClick()">
                            <div class="upload-content">
                                <div class="upload-icon">üì∑</div>
                                <div class="upload-text">
                                    <strong>Clique para enviar foto</strong>
                                    <small>ou arraste uma imagem aqui</small>
                                </div>
                                <div class="upload-limits">
                                    <small>M√°ximo: <span id="photoSizeLimit">5MB</span> | JPG, PNG, GIF</small>
                                </div>
                            </div>
                        </div>
                        <div class="photo-preview" id="photoPreview" style="display: none;">
                            <img id="previewImage" src="" alt="Preview">
                            <div class="photo-actions">
                                <button type="button" class="btn-secondary" onclick="removePhoto()">üóëÔ∏è Remover</button>
                                <button type="button" class="btn-secondary" onclick="document.getElementById('extintorPhoto').click()">üîÑ Trocar</button>
                            </div>
                        </div>
                        <div class="upload-progress" id="uploadProgress" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <span class="progress-text" id="progressText">0%</span>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20,6 9,17 4,12"></polyline>
                        </svg>
                        Salvar Extintor
                    </button>
                    <a href="extintores.html" class="btn btn-secondary">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="m12 19-7-7 7-7"></path>
                            <path d="m19 12-7 7-7-7"></path>
                        </svg>
                        Cancelar
                    </a>
                </div>
            </form>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <div id="bottom-nav-container"></div>

    <script>
        let editandoIndex = null;
        let editandoData = null;

        // Inicializa√ß√£o da p√°gina
        document.addEventListener('DOMContentLoaded', async () => {
            // Verificar se usu√°rio est√° logado
            if (!checkAuth()) return;
            
            // üîí PROTE√á√ÉO DEFINITIVA DE PLANOS - V3.0 FINAL
            // Validar limites SEMPRE que a p√°gina carregar (exceto para edi√ß√£o)
            const editandoExtintor = sessionStorage.getItem('editandoExtintor');
            if (!editandoExtintor && window.PlanValidator) {
                console.log('üõ°Ô∏è PROTE√á√ÉO FORM V3.0 - Validando limites...');
                
                try {
                    // Inicializar o validador primeiro
                    const currentUser = getCurrentUser();
                    if (currentUser && !PlanValidator.initialize(currentUser)) {
                        return; // Plano vencido/inativo
                    }
                    
                    const canCreate = await PlanValidator.canCreateExtintor();
                    if (!canCreate) {
                        console.log('üö´ ACESSO NEGADO - Limite atingido, redirecionando...');
                        // Aguardar 1 segundo para o modal aparecer, depois redirecionar
                        setTimeout(() => {
                            window.location.href = 'extintores.html';
                        }, 1000);
                        return;
                    }
                    console.log('‚úÖ ACESSO LIBERADO - Pode criar extintor');
                } catch (error) {
                    console.error('‚ùå Erro na prote√ß√£o de planos:', error);
                    // Em caso de erro, permitir acesso para n√£o travar o sistema
                }
            }
            
            // Carregar componentes
            await loadNavbarComponent();
            await loadBottomNavComponent();
            setActiveNavItem('form');
            
            // Verificar se est√° editando
            verificarEdicao();
            
            // Configurar upload de foto
            setupPhotoUpload();
        });

        // ===== SISTEMA DE UPLOAD DE FOTOS =====
        
        class PhotoUploadManager {
            constructor() {
                this.currentPhoto = null;
                this.existingPhotoUrl = null; // üì∏ FOTO EXISTENTE (para edi√ß√£o)
                this.isUploading = false;
                this.initializePhotoUpload();
            }

            initializePhotoUpload() {
                const fileInput = document.getElementById('extintorPhoto');
                const uploadZone = document.querySelector('.photo-upload-zone');
                
                if (!fileInput || !uploadZone) return;

                // Verificar limita√ß√µes do plano
                this.checkPlanLimitations();

                // Event listeners
                fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
                
                // Drag & Drop
                uploadZone.addEventListener('dragover', (e) => this.handleDragOver(e));
                uploadZone.addEventListener('dragleave', (e) => this.handleDragLeave(e));
                uploadZone.addEventListener('drop', (e) => this.handleDrop(e));
            }

            checkPlanLimitations() {
                const user = getCurrentUser();
                const plan = user?.plan || 'starter';
                console.log('üîç checkPlanLimitations - Plano original:', plan);
                
                // Se usu√°rio ainda n√£o foi carregado, aguardar
                if (!user) {
                    console.log('‚è≥ Usu√°rio ainda n√£o carregado - aguardando...');
                    setTimeout(() => this.checkPlanLimitations(), 100);
                    return;
                }
                
                const photoFeature = document.querySelector('[data-feature="photo-upload"]');
                const uploadZone = document.querySelector('.photo-upload-zone');
                const sizeLimit = document.getElementById('photoSizeLimit');

                // üîß VERIFICA√á√ÉO CORRIGIDA - Usar verifica√ß√£o direta sem modal
                let canUpload = false;
                
                if (window.PlanValidator && PlanValidator.currentPlan) {
                    const planLimits = PlanValidator.PLANS[PlanValidator.currentPlan];
                    canUpload = planLimits && planLimits.limits && planLimits.limits.photos;
                } else {
                    // Fallback: verificar plano diretamente
                    canUpload = plan !== 'starter';
                }
                
                console.log('üîç checkPlanLimitations - Pode fazer upload:', canUpload);

                if (!canUpload) {
                    // Bloquear funcionalidade para Starter
                    photoFeature?.classList.add('plan-disabled');
                    uploadZone?.classList.add('disabled');
                    
                    // Remover event listeners e desabilitar input
                    const fileInput = document.getElementById('extintorPhoto');
                    if (fileInput) fileInput.disabled = true;
                    
                } else {
                    // Habilitar funcionalidade para Professional/Enterprise
                    photoFeature?.classList.remove('plan-disabled');
                    uploadZone?.classList.remove('disabled');
                    
                    // Habilitar input file
                    const fileInput = document.getElementById('extintorPhoto');
                    if (fileInput) fileInput.disabled = false;
                    
                    // Configurar limites por plano
                    const limits = {
                        professional: '5MB',
                        enterprise: '10MB'
                    };
                    
                    if (sizeLimit) {
                        sizeLimit.textContent = limits[plan] || '5MB';
                    }
                }
                
                console.log('üîç checkPlanLimitations - Estado final das classes:', {
                    photoFeatureClasses: photoFeature?.className,
                    uploadZoneClasses: uploadZone?.className
                });
            }

            handleFileSelect(event) {
                const file = event.target.files[0];
                if (file) {
                    this.processFile(file);
                }
            }

            handleDragOver(event) {
                event.preventDefault();
                event.currentTarget.classList.add('drag-over');
            }

            handleDragLeave(event) {
                event.currentTarget.classList.remove('drag-over');
            }

            handleDrop(event) {
                event.preventDefault();
                event.currentTarget.classList.remove('drag-over');
                
                const files = event.dataTransfer.files;
                if (files.length > 0) {
                    this.processFile(files[0]);
                }
            }

            processFile(file) {
                // Validar tipo de arquivo
                const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                if (!allowedTypes.includes(file.type)) {
                    this.showError('Formato n√£o permitido. Use JPG, PNG, GIF ou WebP.');
                    return;
                }

                // Validar tamanho baseado no plano
                const user = getCurrentUser();
                const plan = user?.plan || 'starter';
                const maxSize = plan === 'enterprise' ? 10 * 1024 * 1024 : 5 * 1024 * 1024; // 10MB ou 5MB

                if (file.size > maxSize) {
                    const maxMB = maxSize / (1024 * 1024);
                    this.showError(`Arquivo muito grande. M√°ximo: ${maxMB}MB para seu plano.`);
                    return;
                }

                // Mostrar preview
                this.showPreview(file);
                this.currentPhoto = file;
            }

            showPreview(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.getElementById('photoPreview');
                    const previewImage = document.getElementById('previewImage');
                    const uploadZone = document.querySelector('.photo-upload-zone');

                    previewImage.src = e.target.result;
                    preview.style.display = 'flex';
                    uploadZone.style.display = 'none';
                };
                reader.readAsDataURL(file);
            }

            async uploadPhoto(extintorId) {
                // üì∏ Se n√£o h√° foto nova e h√° foto existente, retornar dados da foto existente
                if (!this.currentPhoto && this.existingPhotoUrl) {
                    console.log('üîÑ Mantendo foto existente:', this.existingPhotoUrl);
                    return {
                        url: this.existingPhotoUrl,
                        path: null, // N√£o h√° novo caminho, mant√©m o existente
                        isExisting: true
                    };
                }
                
                // Se n√£o h√° foto nova nem existente, retornar null
                if (!this.currentPhoto) return null;

                this.isUploading = true;
                this.showProgress(0);

                try {
                    const fileName = `extintor_${extintorId}_${Date.now()}.${this.getFileExtension(this.currentPhoto.name)}`;
                    
                    // Simular progresso de upload
                    for (let i = 0; i <= 100; i += 10) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        this.showProgress(i);
                    }

                    // Upload real para Supabase
                    const photoUrl = await uploadExtintorPhoto(this.currentPhoto, fileName);
                    
                    this.hideProgress();
                    this.isUploading = false;
                    
                    return {
                        url: photoUrl,
                        path: fileName,
                        isExisting: false
                    };

                } catch (error) {
                    console.error('‚ùå Erro no upload:', error);
                    this.showError('Erro no upload da foto. Tente novamente.');
                    this.hideProgress();
                    this.isUploading = false;
                    return null;
                }
            }

            showProgress(percent) {
                const progress = document.getElementById('uploadProgress');
                const fill = document.getElementById('progressFill');
                const text = document.getElementById('progressText');

                progress.style.display = 'block';
                fill.style.width = `${percent}%`;
                text.textContent = `${percent}%`;
            }

            hideProgress() {
                const progress = document.getElementById('uploadProgress');
                progress.style.display = 'none';
            }

            showError(message) {
                if (typeof showNotification === 'function') {
                    showNotification(message, 'error');
                } else {
                    alert(message);
                }
            }

            getFileExtension(filename) {
                return filename.split('.').pop().toLowerCase();
            }

            reset() {
                this.currentPhoto = null;
                this.existingPhotoUrl = null; // üì∏ LIMPAR FOTO EXISTENTE TAMB√âM
                this.isUploading = false;
                
                const preview = document.getElementById('photoPreview');
                const uploadZone = document.querySelector('.photo-upload-zone');
                const fileInput = document.getElementById('extintorPhoto');
                
                preview.style.display = 'none';
                uploadZone.style.display = 'flex';
                fileInput.value = '';
                
                this.hideProgress();
            }
        }

        // Inst√¢ncia global do gerenciador de fotos
        let photoManager;

        // Configurar funcionalidade de upload de foto
        function setupPhotoUpload() {
            photoManager = new PhotoUploadManager();
        }

        // Fun√ß√£o para o clique na zona de upload
        function handlePhotoZoneClick() {
            console.log('üñ±Ô∏è CLIQUE DETECTADO NA ZONA DE UPLOAD!');
            
            // üîß AGUARDAR PLANVALIDATOR ESTAR DISPON√çVEL
            if (!window.PlanValidator) {
                console.log('‚è≥ PlanValidator n√£o dispon√≠vel ainda, aguardando...');
                setTimeout(() => handlePhotoZoneClick(), 100);
                return;
            }
            
            const user = getCurrentUser();
            const plan = user?.plan || 'starter';
            
            console.log('üñ±Ô∏è DADOS DO CLIQUE:', {
                user: user?.email,
                planOriginal: user?.plan,
                planNormalizado: plan,
                PlanValidatorExists: !!window.PlanValidator,
                PlanValidatorCurrentPlan: window.PlanValidator?.currentPlan,
                PlanValidatorCurrentUser: window.PlanValidator?.currentUser?.email,
                elementClicked: event?.target?.className || 'unknown'
            });
            
            // üîß VERIFICA√á√ÉO CORRIGIDA - Apenas verificar se pode usar, sem modal autom√°tico
            if (window.PlanValidator) {
                // Inicializar o PlanValidator se necess√°rio
                if (!PlanValidator.currentUser) {
                    PlanValidator.initialize(user);
                }
                
                // Verificar se o plano permite fotos diretamente
                const planLimits = PlanValidator.PLANS[PlanValidator.currentPlan];
                const canUsePhotos = planLimits && planLimits.limits && planLimits.limits.photos;
                
                console.log('üîç VERIFICA√á√ÉO DIRETA DE FOTOS:', {
                    currentPlan: PlanValidator.currentPlan,
                    planLimits: planLimits?.limits,
                    canUsePhotos
                });
                
                if (!canUsePhotos) {
                    console.log('‚ùå FOTOS BLOQUEADAS - mostrando modal');
                    PlanValidator.showFeatureUpgradeModal('photos', 'Upload de Fotos', 'Professional');
                    return;
                }
            } else {
                console.log('‚ö†Ô∏è PlanValidator n√£o encontrado!');
                // Fallback: verificar plano diretamente
                if (plan === 'starter') {
                    showUpgradeModal();
                    return;
                }
            }
            
            // Se chegou aqui, pode usar fotos
            console.log('‚úÖ PERMITINDO UPLOAD - abrindo file picker');
            document.getElementById('extintorPhoto').click();
        }

        // üß™ FUN√á√ÉO DE DEBUG - REMOVER EM PRODU√á√ÉO
        function debugPhotoValidation() {
            // Aguardar PlanValidator estar dispon√≠vel
            if (!window.PlanValidator) {
                console.log('‚è≥ DEBUG: PlanValidator n√£o dispon√≠vel ainda, aguardando...');
                setTimeout(debugPhotoValidation, 100);
                return;
            }
            
            const user = getCurrentUser();
            console.log('üîç DEBUG VALIDA√á√ÉO DE FOTOS:', {
                user: user?.email,
                planOriginal: user?.plan || user?.subscription,
                PlanValidatorExists: !!window.PlanValidator,
                currentPlan: window.PlanValidator?.currentPlan,
                canUsePhotos: window.PlanValidator?.canUsePhotos()
            });
        }

        // Modal de upgrade para fotos
        function showUpgradeModal() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal upgrade-modal">
                    <div class="modal-header">
                        <h3>üì∏ Funcionalidade Premium</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="upgrade-content">
                            <div class="feature-icon">üì∑</div>
                            <h4>Upload de Fotos de Extintores</h4>
                            <p>Documente visualmente seus extintores com fotos de alta qualidade!</p>
                            
                            <div class="plan-comparison">
                                <div class="plan-item current">
                                    <span class="plan-name">Starter</span>
                                    <span class="plan-feature disabled">‚ùå Sem fotos</span>
                                </div>
                                <div class="plan-item recommended">
                                    <span class="plan-name">Professional</span>
                                    <span class="plan-feature">‚úÖ Fotos at√© 5MB</span>
                                </div>
                                <div class="plan-item">
                                    <span class="plan-name">Enterprise</span>
                                    <span class="plan-feature">‚úÖ Fotos at√© 10MB</span>
                                </div>
                            </div>
                            
                            <div class="upgrade-benefits">
                                <h5>Benef√≠cios do upgrade:</h5>
                                <ul>
                                    <li>üì∏ Upload de fotos ilimitado</li>
                                    <li>üîç Identifica√ß√£o visual r√°pida</li>
                                    <li>üìä Relat√≥rios com imagens</li>
                                    <li>üíæ Backup autom√°tico das fotos</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Agora N√£o</button>
                        <button class="btn-primary" onclick="window.open('mailto:contato@empresa.com?subject=Upgrade para Professional', '_blank')">üöÄ Fazer Upgrade</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Fun√ß√µes globais para os bot√µes
        function removePhoto() {
            if (photoManager) {
                photoManager.reset();
            }
        }

        // Configurar upload de foto
        setupPhotoUpload();

        function verificarEdicao() {
            const editandoExtintor = sessionStorage.getItem('editandoExtintor');
            
            if (editandoExtintor) {
                const dados = JSON.parse(editandoExtintor);
                editandoIndex = dados.index;
                editandoData = dados.data;
                
                // Atualizar t√≠tulo
                document.getElementById('formTitle').textContent = 'Editar Extintor';
                
                // Preencher formul√°rio
                document.getElementById('numero').value = editandoData.numero || '';
                document.getElementById('local').value = editandoData.local || '';
                document.getElementById('tipo').value = editandoData.tipo || '';
                document.getElementById('peso').value = editandoData.peso || '';
                document.getElementById('validade').value = editandoData.validade || '';
                document.getElementById('hidro').value = editandoData.hidro || '';
                document.getElementById('observacoes').value = editandoData.observacoes || '';
                
                // üì∏ CARREGAR FOTO EXISTENTE
                if (editandoData.photo_url && photoManager) {
                    console.log('üñºÔ∏è Carregando foto existente:', editandoData.photo_url);
                    
                    // Mostrar preview da foto existente
                    const preview = document.getElementById('photoPreview');
                    const previewImage = document.getElementById('previewImage');
                    const uploadZone = document.querySelector('.photo-upload-zone');

                    if (preview && previewImage && uploadZone) {
                        previewImage.src = editandoData.photo_url;
                        preview.style.display = 'flex';
                        uploadZone.style.display = 'none';
                        
                        // Marcar que h√° uma foto existente (n√£o √© upload novo)
                        photoManager.existingPhotoUrl = editandoData.photo_url;
                        console.log('‚úÖ Foto existente carregada no preview');
                    }
                }
                
                // Limpar sessionStorage
                sessionStorage.removeItem('editandoExtintor');
            }
        }

        async function validarFormulario() {
            const numero = document.getElementById('numero').value.trim();
            const local = document.getElementById('local').value.trim();
            const tipo = document.getElementById('tipo').value;
            const peso = document.getElementById('peso').value;
            const validade = document.getElementById('validade').value;
            const hidro = document.getElementById('hidro').value;

            // Valida√ß√£o b√°sica
            if (!numero || !local || !tipo || !peso || !validade || !hidro) {
                showNotification('Por favor, preencha todos os campos obrigat√≥rios.', 'error');
                return false;
            }

            // Verificar duplicatas (s√≥ se n√£o estiver editando)
            if (editandoIndex === null) {
                const extintores = await carregarExtintores();
                const numeroExistente = extintores.find(ext => ext.numero === numero);
                
                if (numeroExistente) {
                    showNotification('J√° existe um extintor com este n√∫mero.', 'error');
                    return false;
                }
            }

            // Valida√ß√£o de datas
            const dataValidade = new Date(validade);
            const dataHidro = new Date(hidro);
            const hoje = new Date();
            
            if (dataValidade <= hoje) {
                showNotification('A data de validade deve ser futura.', 'warning');
            }
            
            if (dataHidro > hoje) {
                showNotification('A data do teste hidrost√°tico n√£o pode ser futura.', 'error');
                return false;
            }

            // Valida√ß√£o de peso
            if (parseFloat(peso) <= 0) {
                showNotification('O peso deve ser maior que zero.', 'error');
                return false;
            }

            return true;
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            
            if (!(await validarFormulario())) {
                return;
            }
            
            // ÔøΩ PROTE√á√ÉO DE EMERG√äNCIA ANTICACHE - V5.0 ABSOLUTA
            // Esta valida√ß√£o funciona SEMPRE, mesmo com cache!
            if (editandoIndex === null) {
                console.log('üö® PROTE√á√ÉO EMERG√äNCIA V5.0 - Validando INLINE...');
                
                try {
                    // üîß CORRE√á√ÉO: Buscar usu√°rio diretamente do sessionStorage
                    const userDataString = sessionStorage.getItem('currentUser');
                    if (!userDataString) {
                        console.error('‚ùå EMERG√äNCIA: Nenhum usu√°rio no sessionStorage');
                        showNotification('Erro: usu√°rio n√£o autenticado.', 'error');
                        return;
                    }
                    
                    const currentUser = JSON.parse(userDataString);
                    if (!currentUser || !currentUser.id) {
                        console.error('‚ùå EMERG√äNCIA: id n√£o encontrado');
                        showNotification('Erro: dados de usu√°rio inv√°lidos.', 'error');
                        return;
                    }
                    
                    console.log('üë§ EMERG√äNCIA: Validando para usu√°rio:', currentUser.id);
                    
                    // Buscar contagem diretamente do usu√°rio correto
                    const response = await fetch(`https://japgbufsqbjfkbkrncgg.supabase.co/rest/v1/extintores?user_id=eq.${currentUser.id}&select=*`, {
                        headers: {
                            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImphcGdidWZzcWJqZmtia3JuY2dnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0OTg3NTksImV4cCI6MjA3MDA3NDc1OX0.AIc0koiJoLrRoFEhvV8qfskpL5ffA-l35cvGNGTLlOs',
                            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImphcGdidWZzcWJqZmtia3JuY2dnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0OTg3NTksImV4cCI6MjA3MDA3NDc1OX0.AIc0koiJoLrRoFEhvV8qfskpL5ffA-l35cvGNGTLlOs'
                        }
                    });
                    
                    const extintores = await response.json();
                    const count = Array.isArray(extintores) ? extintores.length : 0;
                    
                    console.log('üìä Contagem CORRIGIDA (usu√°rio correto):', count);
                    console.log('üî¢ Limite Starter:', 50);
                    
                    if (count >= 50) {
                        console.log('üö´ BLOQUEADO PELA PROTE√á√ÉO DE EMERG√äNCIA!');
                        
                        // Modal de emerg√™ncia com estilo profissional
                        const modal = document.createElement('div');
                        modal.className = 'emergency-modal-overlay';
                        modal.innerHTML = `
                            <div class="emergency-modal-content">
                                <h3>üö´ Limite do Plano Atingido</h3>
                                
                                <div class="limit-info">
                                    <div class="current-plan">
                                        <span class="plan-name">Plano Starter</span>
                                        <span class="plan-limit">At√© 50 extintores</span>
                                    </div>
                                </div>
                                
                                <div class="usage-stats">
                                    <div class="usage-bar">
                                        <div class="usage-fill" style="width: 100%"></div>
                                    </div>
                                    <div class="usage-numbers">
                                        <strong>${count}/50 extintores utilizados</strong>
                                    </div>
                                </div>
                                
                                <p>Voc√™ j√° atingiu o <strong>limite m√°ximo</strong> de extintores do seu plano atual.</p>
                                <p>Para continuar cadastrando equipamentos, fa√ßa upgrade para o <strong>Plano Professional</strong>:</p>
                                
                                <div class="upgrade-highlight">
                                    <div class="upgrade-features">
                                        <span class="feature">üìà <strong>200 extintores</strong></span>
                                        <span class="feature">üì∏ <strong>Upload de fotos</strong></span>
                                        <span class="feature">üìä <strong>Relat√≥rios avan√ßados</strong></span>
                                    </div>
                                    <div class="upgrade-price">
                                        <span class="price">R$ 197/m√™s</span>
                                    </div>
                                </div>
                                
                                <div class="modal-actions">
                                    <button 
                                        type="button"
                                        class="emergency-btn secondary" 
                                        id="btn-ver-extintores"
                                        tabindex="0"
                                        role="button"
                                        aria-label="Ver lista de extintores existentes"
                                    >
                                        üìã Ver Extintores
                                    </button>
                                    <button 
                                        type="button"
                                        class="emergency-btn primary" 
                                        id="btn-fazer-upgrade"
                                        tabindex="0"
                                        role="button"
                                        aria-label="Fazer upgrade do plano"
                                    >
                                        üöÄ Fazer Upgrade
                                    </button>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(modal);
                        
                        // üîß ADICIONAR EVENT LISTENERS PARA MOBILE
                        // Aguardar o modal ser renderizado
                        setTimeout(() => {
                            const btnVerExtintores = document.getElementById('btn-ver-extintores');
                            const btnFazerUpgrade = document.getElementById('btn-fazer-upgrade');
                            
                            if (btnVerExtintores) {
                                // M√∫ltiplos eventos para garantir compatibilidade
                                btnVerExtintores.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    console.log('üñ±Ô∏è Bot√£o Ver Extintores clicado!');
                                    modal.remove();
                                    window.location.href = 'extintores.html';
                                });
                                
                                btnVerExtintores.addEventListener('touchend', function(e) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    console.log('üëÜ Bot√£o Ver Extintores tocado!');
                                    modal.remove();
                                    window.location.href = 'extintores.html';
                                });
                            }
                            
                            if (btnFazerUpgrade) {
                                btnFazerUpgrade.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    console.log('üñ±Ô∏è Bot√£o Fazer Upgrade clicado!');
                                    window.open('mailto:contato@empresa.com?subject=Upgrade para Professional&body=Ol√°! Gostaria de fazer upgrade para o Plano Professional para cadastrar mais extintores.', '_blank');
                                    modal.remove();
                                });
                                
                                btnFazerUpgrade.addEventListener('touchend', function(e) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    console.log('üëÜ Bot√£o Fazer Upgrade tocado!');
                                    window.open('mailto:contato@empresa.com?subject=Upgrade para Professional&body=Ol√°! Gostaria de fazer upgrade para o Plano Professional para cadastrar mais extintores.', '_blank');
                                    modal.remove();
                                });
                            }
                            
                            console.log('‚úÖ Event listeners adicionados aos bot√µes do modal');
                        }, 100);
                        
                        // üõ°Ô∏è FALLBACK: Event delegation no modal overlay
                        modal.addEventListener('click', function(e) {
                            if (e.target.id === 'btn-ver-extintores' || e.target.closest('#btn-ver-extintores')) {
                                e.preventDefault();
                                console.log('üîÑ Fallback: Ver Extintores');
                                modal.remove();
                                window.location.href = 'extintores.html';
                            } else if (e.target.id === 'btn-fazer-upgrade' || e.target.closest('#btn-fazer-upgrade')) {
                                e.preventDefault();
                                console.log('üîÑ Fallback: Fazer Upgrade');
                                window.open('mailto:contato@empresa.com?subject=Upgrade para Professional&body=Ol√°! Gostaria de fazer upgrade para o Plano Professional para cadastrar mais extintores.', '_blank');
                                modal.remove();
                            }
                        });
                        
                        // üì± FALLBACK ESPEC√çFICO PARA TOUCH
                        modal.addEventListener('touchstart', function(e) {
                            if (e.target.id === 'btn-ver-extintores' || e.target.closest('#btn-ver-extintores')) {
                                e.target.style.opacity = '0.8';
                            } else if (e.target.id === 'btn-fazer-upgrade' || e.target.closest('#btn-fazer-upgrade')) {
                                e.target.style.opacity = '0.8';
                            }
                        });
                        
                        modal.addEventListener('touchend', function(e) {
                            const targetBtn = e.target.id === 'btn-ver-extintores' || e.target.closest('#btn-ver-extintores') ? 'ver' :
                                            e.target.id === 'btn-fazer-upgrade' || e.target.closest('#btn-fazer-upgrade') ? 'upgrade' : null;
                            
                            // Restaurar opacidade
                            if (targetBtn) {
                                e.target.style.opacity = '1';
                                e.preventDefault();
                                
                                if (targetBtn === 'ver') {
                                    console.log('üì± Touch fallback: Ver Extintores');
                                    modal.remove();
                                    setTimeout(() => window.location.href = 'extintores.html', 100);
                                } else if (targetBtn === 'upgrade') {
                                    console.log('üì± Touch fallback: Fazer Upgrade');
                                    window.open('mailto:contato@empresa.com?subject=Upgrade para Professional&body=Ol√°! Gostaria de fazer upgrade para o Plano Professional para cadastrar mais extintores.', '_blank');
                                    setTimeout(() => modal.remove(), 100);
                                }
                            }
                        });
                        return;
                    }
                    
                    console.log('‚úÖ EMERG√äNCIA: Pode criar extintor');
                } catch (error) {
                    console.error('‚ùå Erro na prote√ß√£o de emerg√™ncia:', error);
                    showNotification('Erro ao validar limites. Tente novamente.', 'error');
                    return;
                }
            }
            
            // ÔøΩüõ°Ô∏è PROTE√á√ÉO DUPLA NO SUBMIT - V3.0 FINAL
            // Validar limite do plano (apenas para novos extintores)
            if (editandoIndex === null && window.PlanValidator) {
                console.log('üõ°Ô∏è PROTE√á√ÉO SUBMIT - Validando limites antes de salvar...');
                
                try {
                    const canCreate = await PlanValidator.canCreateExtintor();
                    if (!canCreate) {
                        console.log('üö´ SUBMIT BLOQUEADO - Limite atingido');
                        return; // Modal de upgrade j√° foi exibido
                    }
                    console.log('‚úÖ SUBMIT LIBERADO - Pode criar extintor');
                } catch (error) {
                    console.error('‚ùå Erro na valida√ß√£o do submit:', error);
                    showNotification('Erro ao validar limites do plano. Tente novamente.', 'error');
                    return;
                }
            }
            
            const extintor = {
                numero: document.getElementById('numero').value.trim(),
                local: document.getElementById('local').value.trim(),
                tipo: document.getElementById('tipo').value,
                peso: parseFloat(document.getElementById('peso').value),
                validade: document.getElementById('validade').value,
                hidro: document.getElementById('hidro').value,
                observacoes: document.getElementById('observacoes').value.trim() || null
            };
            
            // Se estiver editando, incluir ID
            if (editandoData && editandoData.id) {
                extintor.id = editandoData.id;
            }
            
            try {
                // Verificar se h√° upload em andamento
                if (photoManager && photoManager.isUploading) {
                    showNotification('Aguarde o upload da foto terminar...', 'warning');
                    return;
                }
                
                // Primeiro salvar o extintor
                const sucesso = await salvarExtintor(extintor);
                
                if (sucesso) {
                    let extintorId = extintor.id;
                    
                    // Se √© um novo extintor, precisamos buscar o ID gerado
                    if (!extintorId) {
                        const savedExtintores = await carregarExtintores();
                        const lastExtintor = savedExtintores.find(e => e.numero === extintor.numero);
                        extintorId = lastExtintor?.id || Date.now();
                    }
                    
                    // Se h√° uma foto (nova ou existente) e gerenciador de fotos dispon√≠vel
                    if (photoManager && (photoManager.currentPhoto || photoManager.existingPhotoUrl)) {
                        try {
                            showNotification('Processando foto...', 'info');
                            
                            const photoData = await photoManager.uploadPhoto(extintorId);
                            
                            if (photoData) {
                                // S√≥ atualizar a URL no banco se n√£o √© foto existente
                                if (!photoData.isExisting && typeof updateExtintorPhotoUrl === 'function') {
                                    await updateExtintorPhotoUrl(extintorId, photoData.url, photoData.path);
                                    showNotification('Extintor e foto salvos com sucesso!', 'success');
                                } else if (photoData.isExisting) {
                                    showNotification('Extintor atualizado com sucesso!', 'success');
                                } else {
                                    showNotification('Extintor salvo, mas erro no upload da foto.', 'warning');
                                }
                            } else {
                                showNotification('Extintor salvo, mas erro no upload da foto.', 'warning');
                            }
                            
                            photoManager.reset();
                        } catch (photoError) {
                            console.warn('‚ö†Ô∏è Erro no upload da foto:', photoError);
                            showNotification('Extintor salvo, mas erro no upload da foto.', 'warning');
                        }
                    } else {
                        const mensagem = editandoIndex !== null 
                            ? 'Extintor atualizado com sucesso!' 
                            : 'Extintor cadastrado com sucesso!';
                        
                        showNotification(mensagem, 'success');
                    }
                    
                    // Redirecionar para lista
                    setTimeout(() => {
                        window.location.href = 'extintores.html';
                    }, 1500);
                }
            } catch (error) {
                console.error('Erro ao salvar extintor:', error);
                showNotification('Erro ao salvar extintor. Tente novamente.', 'error');
            }
        }

        // Event listeners
        document.getElementById('form').addEventListener('submit', handleFormSubmit);

        // Definir data m√≠nima para o teste hidrost√°tico (n√£o pode ser futura)
        document.getElementById('hidro').max = new Date().toISOString().split('T')[0];
        
        // Definir data m√≠nima para validade (hoje)
        document.getElementById('validade').min = new Date().toISOString().split('T')[0];
    </script>

    <style>
        .form-help {
            display: block;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
            font-style: italic;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .form-actions .btn {
            flex: 1;
            min-width: 150px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        @media (max-width: 640px) {
            .form-actions {
                flex-direction: column;
            }
            
            .form-actions .btn {
                width: 100%;
            }
        }

        /* Adicionar indicador de campo obrigat√≥rio */
        .form-group label::after {
            content: "";
        }

        .form-group label[for="numero"]::after,
        .form-group label[for="local"]::after,
        .form-group label[for="tipo"]::after,
        .form-group label[for="peso"]::after,
        .form-group label[for="validade"]::after,
        .form-group label[for="hidro"]::after {
            content: " *";
            color: var(--danger-color);
        }

        /* Estilo para campos inv√°lidos */
        .form-group input:invalid,
        .form-group select:invalid {
            border-color: var(--danger-color);
        }

        .form-group input:valid,
        .form-group select:valid {
            border-color: var(--success-color);
        }
    </style>
    
    <!-- <script src="../js/pwa-manager.js"></script> -->
</body>
</html>
