<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inspe√ß√£o de Extintores</title>
  <!-- <link rel="stylesheet" href="../styles/styles.css"> -->
  <link rel="stylesheet" href="../css/common.css">
  <link rel="stylesheet" href="../css/navigation.css">
  <link rel="stylesheet" href="../css/mobile-fixes.css">
  <link rel="stylesheet" href="../css/mobile-enhancements.css">
  <link rel="stylesheet" href="../css/extintores-page.css">
  <link rel="stylesheet" href="../css/extintor-cards.css">
  <link rel="stylesheet" href="../css/plan-styles.css">
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="../js/supabase-config.js"></script>
</head>
<body>

  <body>
    <!-- NAVBAR -->
    <div id="navbar-include"></div>
    <main class="main-content" style="max-width: 480px;">
      <div style="display: flex; justify-content: center; margin-bottom: 2rem;">
        <button id="btn-nova-inspecao" class="btn btn-primary" style="font-size: 1.1rem; padding: 1rem 2rem;">
          <span style="font-size: 1.3em; vertical-align: middle;">üì∑</span> Nova Inspe√ß√£o
        </button>
      </div>
      <section id="scanner-section" class="card" style="padding: 1.5rem 1rem; margin-bottom: 1.5rem; display: none;">
        <div class="d-flex align-items-center mb-2" style="gap: 0.5rem;">
          <span style="font-size: 1.5rem;">üì∑</span>
          <span style="font-weight: 600; font-size: 1.1rem;">Scanner de QR Code</span>
        </div>
        <div id="reader"></div>
        <p id="scan-result" class="text-muted mt-2">Aproxime o QR Code do extintor...</p>
      </section>
      <section id="extintor-info" class="card extintor-info" style="display:none; padding: 1.25rem 1rem; margin-bottom: 1.25rem;">
        <h3 class="mb-2" style="font-size: 1.1rem; color: var(--primary-color);">Dados do Extintor</h3>
        <div class="d-flex flex-column" style="gap: 0.25rem;">
          <div><b>N√∫mero:</b> <span id="ext-numero"></span></div>
          <div><b>Local:</b> <span id="ext-local"></span></div>
          <div><b>Tipo:</b> <span id="ext-tipo"></span></div>
          <div><b>√öltima inspe√ß√£o:</b> <span id="ext-inspecao"></span></div>
        </div>
      </section>
      <section id="checklist" class="card checklist" style="display:none; padding: 1.5rem 1rem;">
        <h3 class="mb-3" style="font-size: 1.2rem; color: var(--primary-color);">Checklist</h3>
        <div style="display: flex; flex-direction: column; gap: 1.1rem; margin-bottom: 1.5rem;">
          <label style="display: flex; align-items: center; gap: 1rem; font-size: 1.15rem; font-weight: 500; background: var(--bg-tertiary); border-radius: var(--radius-md); padding: 1rem 1rem 1rem 0.75rem; box-shadow: var(--shadow-sm);">
            <input type="checkbox" style="width: 1.6em; height: 1.6em; accent-color: var(--primary-color); margin-right: 0.5em;">
            Selo INMETRO
          </label>
          <label style="display: flex; align-items: center; gap: 1rem; font-size: 1.15rem; font-weight: 500; background: var(--bg-tertiary); border-radius: var(--radius-md); padding: 1rem 1rem 1rem 0.75rem; box-shadow: var(--shadow-sm);">
            <input type="checkbox" style="width: 1.6em; height: 1.6em; accent-color: var(--primary-color); margin-right: 0.5em;">
            Press√£o OK
          </label>
          <label style="display: flex; align-items: center; gap: 1rem; font-size: 1.15rem; font-weight: 500; background: var(--bg-tertiary); border-radius: var(--radius-md); padding: 1rem 1rem 1rem 0.75rem; box-shadow: var(--shadow-sm);">
            <input type="checkbox" style="width: 1.6em; height: 1.6em; accent-color: var(--primary-color); margin-right: 0.5em;">
            Acess√≠vel
          </label>
          <label style="display: flex; align-items: center; gap: 1rem; font-size: 1.15rem; font-weight: 500; background: var(--bg-tertiary); border-radius: var(--radius-md); padding: 1rem 1rem 1rem 0.75rem; box-shadow: var(--shadow-sm);">
            <input type="checkbox" style="width: 1.6em; height: 1.6em; accent-color: var(--primary-color); margin-right: 0.5em;">
            Dentro da validade
          </label>
        </div>

        <button id="salvar" class="btn btn-primary w-100" style="font-size: 1.1rem; padding: 1rem;">Salvar Inspe√ß√£o</button>
      </section>
      <div id="placeholder" class="empty-placeholder" style="display:none;">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" 
          viewBox="0 0 24 24"><path stroke-linecap="round" 
          stroke-linejoin="round" stroke-width="2" 
          d="M15 10l4.553 2.276A1 1 0 0120 13.118V19a1 
          1 0 01-.553.894L15 22v-5l-6-3v5l-4.447-2.106A1 
          1 0 014 19v-5.882a1 1 0 01.447-.842L10 
          10V5l5-3v8z"/></svg>
        <h3>Nenhum extintor escaneado</h3>
        <p>Aponte a c√¢mera para o QR Code de um extintor para come√ßar.</p>
      </div>
      <!-- Lista de Extintores Verificados -->
      <section id="inspecoes-list" class="card" style="margin-top: 2rem; display: none;">
        <h3 style="font-size: 1.1rem; color: var(--primary-color); margin-bottom: 1rem;">Extintores</h3>
        <div style="display: flex; gap: 2rem; flex-wrap: wrap; justify-content: center;">
          <div style="flex:1; min-width:220px;">
            <h4 style="color:var(--success-color); margin-bottom:0.5rem;">Verificados</h4>
            <div style="display:flex; gap:0.5em; align-items:center; margin-bottom:0.5em;">
              <label for="filtro-local-verificados" style="font-size:0.95rem;">Local:</label>
              <select id="filtro-local-verificados" style="min-width:90px; padding:0.3em 0.6em; font-size:0.98rem; border-radius:6px; border:1px solid var(--border-color);"></select>
              <label for="filtro-tipo-verificados" style="font-size:0.95rem; margin-left:0.5em;">Tipo:</label>
              <select id="filtro-tipo-verificados" style="min-width:90px; padding:0.3em 0.6em; font-size:0.98rem; border-radius:6px; border:1px solid var(--border-color);"></select>
            </div>
            <div id="verificados-table"></div>
          </div>
          <div style="flex:1; min-width:220px;">
            <h4 style="color:var(--warning-color); margin-bottom:0.5rem;">Faltam Verificar</h4>
            <div style="display:flex; gap:0.5em; align-items:center; margin-bottom:0.5em;">
              <label for="filtro-local-faltam" style="font-size:0.95rem;">Local:</label>
              <select id="filtro-local-faltam" style="min-width:90px; padding:0.3em 0.6em; font-size:0.98rem; border-radius:6px; border:1px solid var(--border-color);"></select>
              <label for="filtro-tipo-faltam" style="font-size:0.95rem; margin-left:0.5em;">Tipo:</label>
              <select id="filtro-tipo-faltam" style="min-width:90px; padding:0.3em 0.6em; font-size:0.98rem; border-radius:6px; border:1px solid var(--border-color);"></select>
            </div>
            <div id="faltam-table"></div>
          </div>
        </div>
      </section>
    </main>
    <!-- BOTTOM NAV -->
    <div id="bottom-nav-include"></div>
  <!-- BOTTOM NAV -->
  <div id="bottom-nav-include"></div>

  <script>
    // Inclui navbar e bottom-nav
    fetch('../components/navbar.html').then(r => r.text()).then(html => {
      document.getElementById('navbar-include').innerHTML = html;
    });
    fetch('../components/bottom-nav.html').then(r => r.text()).then(html => {
      document.getElementById('bottom-nav-include').innerHTML = html;
    });

    // Fun√ß√£o para renderizar a tabela/lista de inspe√ß√µes

    async function renderInspecoes() {
      const listaSection = document.getElementById('inspecoes-list');
      const verificadosDiv = document.getElementById('verificados-table');
      const faltamDiv = document.getElementById('faltam-table');
      let inspecoes = JSON.parse(localStorage.getItem('inspecoes') || '[]');
      // Remove inspe√ß√µes com mais de 30 dias
      const agora = new Date();
      inspecoes = inspecoes.filter(i => {
        if (!i.createdAt) return true;
        const dataCriacao = new Date(i.createdAt);
        const diffDias = (agora - dataCriacao) / (1000 * 60 * 60 * 24);
        return diffDias <= 30;
      });
      localStorage.setItem('inspecoes', JSON.stringify(inspecoes));
      let extintores = [];
      try {
        if (window.SupabaseManager) {
          const supabase = new window.SupabaseManager();
          extintores = await supabase.getExtintores();
        } else if (window.supabaseManager) {
          extintores = await window.supabaseManager.getExtintores();
        }
      } catch (e) {
        console.error('Erro ao buscar extintores do usu√°rio:', e);
      }

  // Preenche op√ß√µes dos filtros para cada tabela (agora usando numero)
  const locaisVer = Array.from(new Set(extintores.filter(e => inspecoes.some(i => String(i.numero) === String(e.numero))).map(e => e.local).filter(Boolean)));
  const tiposVer = Array.from(new Set(extintores.filter(e => inspecoes.some(i => String(i.numero) === String(e.numero))).map(e => e.tipo).filter(Boolean)));
  const locaisFal = Array.from(new Set(extintores.filter(e => !inspecoes.some(i => String(i.numero) === String(e.numero))).map(e => e.local).filter(Boolean)));
  const tiposFal = Array.from(new Set(extintores.filter(e => !inspecoes.some(i => String(i.numero) === String(e.numero))).map(e => e.tipo).filter(Boolean)));

      const filtroLocalVer = document.getElementById('filtro-local-verificados');
      const filtroTipoVer = document.getElementById('filtro-tipo-verificados');
      const filtroLocalFal = document.getElementById('filtro-local-faltam');
      const filtroTipoFal = document.getElementById('filtro-tipo-faltam');

      if (filtroLocalVer && filtroTipoVer) {
        const prevLocal = filtroLocalVer.value;
        const prevTipo = filtroTipoVer.value;
        filtroLocalVer.innerHTML = '<option value="">Todos Locais</option>' + locaisVer.map(l => `<option value="${l}">${l}</option>`).join('');
        filtroTipoVer.innerHTML = '<option value="">Todos Tipos</option>' + tiposVer.map(t => `<option value="${t}">${t}</option>`).join('');
        if (prevLocal) filtroLocalVer.value = prevLocal;
        if (prevTipo) filtroTipoVer.value = prevTipo;
      }
      if (filtroLocalFal && filtroTipoFal) {
        const prevLocal = filtroLocalFal.value;
        const prevTipo = filtroTipoFal.value;
        filtroLocalFal.innerHTML = '<option value="">Todos Locais</option>' + locaisFal.map(l => `<option value="${l}">${l}</option>`).join('');
        filtroTipoFal.innerHTML = '<option value="">Todos Tipos</option>' + tiposFal.map(t => `<option value="${t}">${t}</option>`).join('');
        if (prevLocal) filtroLocalFal.value = prevLocal;
        if (prevTipo) filtroTipoFal.value = prevTipo;
      }

      // L√™ filtros selecionados
      const localVer = filtroLocalVer ? filtroLocalVer.value : '';
      const tipoVer = filtroTipoVer ? filtroTipoVer.value : '';
      const localFal = filtroLocalFal ? filtroLocalFal.value : '';
      const tipoFal = filtroTipoFal ? filtroTipoFal.value : '';

  // Mapas para busca r√°pida (agora usando numero)
  const verificadosNumeros = new Set(inspecoes.map(i => String(i.numero)));
  let verificados = extintores.filter(e => verificadosNumeros.has(String(e.numero)));
  let faltam = extintores.filter(e => !verificadosNumeros.has(String(e.numero)));

      // Aplica filtros independentes
      if (localVer) verificados = verificados.filter(e => e.local === localVer);
      if (tipoVer) verificados = verificados.filter(e => e.tipo === tipoVer);
      if (localFal) faltam = faltam.filter(e => e.local === localFal);
      if (tipoFal) faltam = faltam.filter(e => e.tipo === tipoFal);

      // Render verificados com clique para mostrar checklist
      if (verificados.length) {
        // Modal HTML (adicionado uma vez s√≥)
        if (!document.getElementById('modal-checklist')) {
          const modal = document.createElement('div');
          modal.id = 'modal-checklist';
          modal.style = 'display:none; position:fixed; z-index:9999; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.35); align-items:center; justify-content:center;';
          modal.innerHTML = `<div id="modal-checklist-content" style="background:#fff; border-radius:12px; max-width:90vw; min-width:220px; padding:2rem 1.2rem; box-shadow:0 2px 16px #0002; position:relative;">
            <button id="modal-checklist-close" style="position:absolute; top:0.5em; right:0.7em; font-size:1.5em; background:none; border:none; cursor:pointer;">&times;</button>
            <h3 style='margin-bottom:1em; color:var(--primary-color); font-size:1.1em;'>Checklist do Extintor</h3>
            <div id="modal-checklist-body"></div>
          </div>`;
          document.body.appendChild(modal);
          document.getElementById('modal-checklist-close').onclick = () => {
            modal.style.display = 'none';
          };
          modal.onclick = (e) => { if (e.target === modal) modal.style.display = 'none'; };
        }

        let html = `<table style="width:100%; border-collapse:collapse;">
          <thead><tr style="background:var(--bg-tertiary); color:var(--text-secondary);">
            <th style="padding:8px;">N√∫mero</th>
            <th style="padding:8px;">Local</th>
            <th style="padding:8px;">Tipo</th>
            <th style="padding:8px; text-align:center;">Checklist</th>
          </tr></thead><tbody>`;
        for (const ext of verificados) {
          const insp = inspecoes.find(i => String(i.numero) === String(ext.numero));
          let checklistIcon = '';
          let checklistData = [];
          if (insp && insp.checklist) {
            const labels = ['Selo INMETRO', 'Press√£o OK', 'Acess√≠vel', 'Dentro da validade'];
            let allOk = labels.every(label => insp.checklist.includes(label));
            checklistIcon = `<span class="checklist-emoji" data-numero="${ext.numero}" style="font-size:1.3em; cursor:pointer; color:${allOk ? 'var(--success-color)' : 'var(--danger-color)'};">${allOk ? '‚úîÔ∏è' : '‚ùå'}</span>`;
            checklistData = labels.map(label => ({label, ok: insp.checklist.includes(label)}));
          } else {
            checklistIcon = '<span style="color:var(--text-muted);">-</span>';
          }
          html += `<tr style="border-bottom:1px solid var(--border-color);">
            <td style="padding:8px;">${ext.numero || '-'}</td>
            <td style="padding:8px;">${ext.local || '-'}</td>
            <td style="padding:8px;">${ext.tipo || '-'}</td>
            <td style="padding:8px; text-align:center;">${checklistIcon}</td>
          </tr>`;
        }
        html += '</tbody></table>';
        verificadosDiv.innerHTML = html;

        // Adiciona evento para abrir modal ao clicar no emoji
        verificadosDiv.querySelectorAll('.checklist-emoji').forEach(el => {
          el.onclick = function() {
            const numero = this.getAttribute('data-numero');
            const insp = inspecoes.find(i => String(i.numero) === String(numero));
            const labels = ['Selo INMETRO', 'Press√£o OK', 'Acess√≠vel', 'Dentro da validade'];
            let html = '<ul style="list-style:none; padding:0; margin:0;">';
            for (const label of labels) {
              const ok = insp && insp.checklist && insp.checklist.includes(label);
              html += `<li style="margin-bottom:0.5em; font-size:1.1em; color:${ok ? 'var(--success-color)' : 'var(--danger-color)'};">${ok ? '‚úîÔ∏è' : '‚ùå'} ${label}</li>`;
            }
            html += '</ul>';
            document.getElementById('modal-checklist-body').innerHTML = html;
            document.getElementById('modal-checklist').style.display = 'flex';
          };
        });
      } else {
        verificadosDiv.innerHTML = '<p style="color: var(--text-muted); text-align:center;">Nenhum verificado.</p>';
      }

      // Render faltam
      if (faltam.length) {
        let html = `<table style="width:100%; border-collapse:collapse;">
          <thead><tr style="background:var(--bg-tertiary); color:var(--text-secondary);">
            <th style="padding:8px;">N√∫mero</th>
            <th style="padding:8px;">Local</th>
            <th style="padding:8px;">Tipo</th>
          </tr></thead><tbody>`;
        for (const ext of faltam) {
          html += `<tr style="border-bottom:1px solid var(--border-color);">
            <td style="padding:8px;">${ext.numero || '-'}</td>
            <td style="padding:8px;">${ext.local || '-'}</td>
            <td style="padding:8px;">${ext.tipo || '-'}</td>
          </tr>`;
        }
        html += '</tbody></table>';
        faltamDiv.innerHTML = html;
      } else {
        faltamDiv.innerHTML = '<p style="color: var(--text-muted); text-align:center;">Todos verificados!</p>';
      }

  // Adiciona eventos de filtro independentes
  if (filtroLocalVer) filtroLocalVer.onchange = renderInspecoes;
  if (filtroTipoVer) filtroTipoVer.onchange = renderInspecoes;
  if (filtroLocalFal) filtroLocalFal.onchange = renderInspecoes;
  if (filtroTipoFal) filtroTipoFal.onchange = renderInspecoes;

      listaSection.style.display = 'block';
    }

    // Fun√ß√£o para salvar inspe√ß√£o
    function salvarInspecao() {
      const numero = document.getElementById('ext-numero').innerText;
      const local = document.getElementById('ext-local').innerText;
      const tipo = document.getElementById('ext-tipo').innerText;
      const data = new Date().toLocaleDateString('pt-BR');
      const createdAt = new Date().toISOString();
      const checklistLabels = [
        'Selo INMETRO',
        'Press√£o OK',
        'Acess√≠vel',
        'Dentro da validade'
      ];
      const checklistInputs = document.querySelectorAll('#checklist input[type="checkbox"]');
      const checklistMarcados = [];
      checklistInputs.forEach((input, idx) => {
        if (input.checked) checklistMarcados.push(checklistLabels[idx]);
      });
  // campo de observa√ß√µes removido
      let inspecoes = JSON.parse(localStorage.getItem('inspecoes') || '[]');
  inspecoes.unshift({ numero, local, tipo, data, checklist: checklistMarcados, createdAt });
      localStorage.setItem('inspecoes', JSON.stringify(inspecoes));
      renderInspecoes();
      // Limpa checklist ap√≥s salvar
      checklistInputs.forEach(input => input.checked = false);
  // campo de observa√ß√µes removido
      // Esconde checklist e info ap√≥s salvar
      document.getElementById('checklist').style.display = 'none';
      document.getElementById('extintor-info').style.display = 'none';
      document.getElementById('scanner-section').style.display = 'none';

      // Mostra bot√£o para nova inspe√ß√£o
      let btnOutra = document.getElementById('btn-outra-inspecao');
      if (!btnOutra) {
        btnOutra = document.createElement('button');
        btnOutra.id = 'btn-outra-inspecao';
        btnOutra.className = 'btn btn-primary w-100';
        btnOutra.style.fontSize = '1.1rem';
        btnOutra.style.padding = '1rem';
        btnOutra.style.marginTop = '1.2rem';
        btnOutra.innerText = 'Realizar outra inspe√ß√£o';
        btnOutra.onclick = function() {
          btnOutra.remove();
          document.getElementById('scanner-section').style.display = 'block';
          document.getElementById('extintor-info').style.display = 'none';
          document.getElementById('checklist').style.display = 'none';
          document.getElementById('placeholder').style.display = 'none';
          // Sempre reinicializa o scanner para garantir uso da traseira
          if (html5QrcodeScanner && html5QrcodeScanner.clear) {
            html5QrcodeScanner.clear();
            html5QrcodeScanner = null;
          }
          if (!window.html5QrcodeInstance) {
            window.html5QrcodeInstance = new Html5Qrcode("reader");
          }
          const config = { fps: 10, qrbox: 200, facingMode: { exact: "environment" } };
          window.html5QrcodeInstance.start(
            { facingMode: "environment" },
            config,
            onScanSuccess
          ).catch(err => {
            document.getElementById("scan-result").innerText = "Erro ao acessar c√¢mera traseira: " + err;
          });
        };
        // Adiciona ap√≥s a lista de inspe√ß√µes
        const main = document.querySelector('main');
        if (main) main.appendChild(btnOutra);
      }
      alert('Inspe√ß√£o salva!');
    }

    // Estado do scanner
    let html5QrcodeScanner = null;

    // Adiciona eventos
    document.addEventListener('DOMContentLoaded', function() {
      const btnSalvar = document.getElementById('salvar');
      if (btnSalvar) btnSalvar.onclick = salvarInspecao;
      renderInspecoes();
      // Bot√£o Nova Inspe√ß√£o
      document.getElementById('btn-nova-inspecao').onclick = function() {
        document.getElementById('scanner-section').style.display = 'block';
        document.getElementById('extintor-info').style.display = 'none';
        document.getElementById('checklist').style.display = 'none';
        document.getElementById('placeholder').style.display = 'none';
        // Inicializa scanner se n√£o existir
        // Sempre reinicializa o scanner para garantir uso da traseira
        if (html5QrcodeScanner && html5QrcodeScanner.clear) {
          html5QrcodeScanner.clear();
          html5QrcodeScanner = null;
        }
        // Usa diretamente a API Html5Qrcode para escolher a traseira
        if (!window.html5QrcodeInstance) {
          window.html5QrcodeInstance = new Html5Qrcode("reader");
        }
        const config = { fps: 10, qrbox: 200, facingMode: { exact: "environment" } };
        window.html5QrcodeInstance.start(
          { facingMode: "environment" },
          config,
          onScanSuccess
        ).catch(err => {
          document.getElementById("scan-result").innerText = "Erro ao acessar c√¢mera traseira: " + err;
        });
      };
    });

    function onScanSuccess(decodedText) {
  document.getElementById("scan-result").innerText = `Extintor encontrado!`;

      // Buscar informa√ß√µes reais do extintor no Supabase
      (async () => {
        let extintor = null;
        try {
          let extintores = [];
          if (window.SupabaseManager) {
            const supabase = new window.SupabaseManager();
            extintores = await supabase.getExtintores();
          } else if (window.supabaseManager) {
            extintores = await window.supabaseManager.getExtintores();
          }
          extintor = extintores.find(e => String(e.id) === String(decodedText));
        } catch (e) {
          console.error('Erro ao buscar extintor:', e);
        }
        if (extintor) {
          document.getElementById("ext-numero").innerText = extintor.numero || '-';
          document.getElementById("ext-local").innerText = extintor.local || '-';
          document.getElementById("ext-tipo").innerText = extintor.tipo || '-';
          document.getElementById("ext-inspecao").innerText = extintor.ultima_inspecao || '-';
        } else {
          document.getElementById("ext-numero").innerText = '-';
          document.getElementById("ext-local").innerText = '-';
          document.getElementById("ext-tipo").innerText = '-';
          document.getElementById("ext-inspecao").innerText = '-';
        }
        // Exibe info e checklist
        document.getElementById("extintor-info").style.display = "block";
        document.getElementById("checklist").style.display = "block";
        document.getElementById("scanner-section").style.display = "none";
      })();
    }
  </script>
  </body>
  </html>
</body>
</html>
