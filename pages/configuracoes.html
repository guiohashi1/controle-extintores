<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#121212">
    <title>Configurações - Controle de Extintores</title>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/common.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/navigation.css">
</head>
<body>
    <!-- Navigation Bar -->
    <div id="navbar-container"></div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="screen-header">
            <h1>Configurações</h1>
            <p>Gerencie suas preferências e dados</p>
        </div>
        
        <!-- Perfil do Usuário -->
        <div class="card">
            <div class="card-header">
                <h3>Perfil do Usuário</h3>
            </div>
            
            <form id="perfilForm">
                <div class="form-group">
                    <label for="userName">Nome</label>
                    <input type="text" id="userName" placeholder="Seu nome completo">
                </div>
                <div class="form-group">
                    <label for="userEmail">Email</label>
                    <input type="email" id="userEmail" placeholder="seu@email.com" readonly>
                    <small class="form-help">O email não pode ser alterado</small>
                </div>
                <div class="form-group">
                    <label for="userPlano">Plano</label>
                    <input type="text" id="userPlano" readonly>
                    <small class="form-help">Para alterar o plano, entre em contato</small>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20,6 9,17 4,12"></polyline>
                    </svg>
                    Salvar Perfil
                </button>
            </form>
        </div>

        <!-- Preferências -->
        <div class="card">
            <div class="card-header">
                <h3>Preferências</h3>
            </div>
            
            <div class="configuracao-item">
                <div class="config-info">
                    <label for="alertasEmail">Alertas por Email</label>
                    <small>Receber notificações de vencimento por email</small>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="alertasEmail">
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="configuracao-item">
                <div class="config-info">
                    <label for="alertasDias">Antecedência dos Alertas</label>
                    <small>Quantos dias antes do vencimento alertar</small>
                </div>
                <select id="alertasDias">
                    <option value="7">7 dias</option>
                    <option value="15">15 dias</option>
                    <option value="30" selected>30 dias</option>
                    <option value="60">60 dias</option>
                </select>
            </div>
            
            <div class="configuracao-item">
                <div class="config-info">
                    <label for="autoBackup">Backup Automático</label>
                    <small>Fazer backup automático dos dados</small>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="autoBackup" checked>
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <!-- Gerenciamento de Dados -->
        <div class="card">
            <div class="card-header">
                <h3>Gerenciamento de Dados</h3>
            </div>
            
            <div class="data-actions">
                <div class="action-item">
                    <div class="action-info">
                        <h4>Exportar Dados</h4>
                        <p>Baixar todos os seus dados em formato JSON</p>
                    </div>
                    <button onclick="exportarDados()" class="btn btn-secondary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7,10 12,15 17,10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Exportar
                    </button>
                </div>
                
                <div class="action-item">
                    <div class="action-info">
                        <h4>Importar Dados</h4>
                        <p>Importar dados de um backup anterior</p>
                    </div>
                    <label for="importFile" class="btn btn-secondary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17,8 12,3 7,8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        Importar
                    </label>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importarDados(event)">
                </div>
                
                <div class="action-item">
                    <div class="action-info">
                        <h4>Limpar Cache</h4>
                        <p>Limpar dados temporários e cache do navegador</p>
                    </div>
                    <button onclick="limparCache()" class="btn btn-secondary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18l-1.5 9a2 2 0 0 1-2 2H6.5a2 2 0 0 1-2-2L3 6Z"></path>
                            <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            <line x1="10" y1="11" x2="10" y2="17"></line>
                            <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                        Limpar Cache
                    </button>
                </div>
            </div>
        </div>

        <!-- Informações do Sistema -->
        <div class="card">
            <div class="card-header">
                <h3>Informações do Sistema</h3>
            </div>
            
            <div class="sistema-info">
                <div class="info-item">
                    <span class="info-label">Versão:</span>
                    <span class="info-value">1.0.0</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Último Login:</span>
                    <span class="info-value" id="ultimoLogin">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Total de Extintores:</span>
                    <span class="info-value" id="totalExtintoresInfo">0</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Espaço Usado:</span>
                    <span class="info-value" id="espacoUsado">-</span>
                </div>
            </div>
        </div>

        <!-- Zona Perigosa -->
        <div class="card danger-zone">
            <div class="card-header">
                <h3>Zona Perigosa</h3>
            </div>
            
            <div class="danger-actions">
                <div class="action-item">
                    <div class="action-info">
                        <h4>Apagar Todos os Dados</h4>
                        <p>Remove permanentemente todos os extintores cadastrados</p>
                    </div>
                    <button onclick="confirmarLimpezaTotal()" class="btn btn-danger">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18l-1.5 9a2 2 0 0 1-2 2H6.5a2 2 0 0 1-2-2L3 6Z"></path>
                            <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                        Apagar Tudo
                    </button>
                </div>
                
                <div class="action-item">
                    <div class="action-info">
                        <h4>Excluir Conta</h4>
                        <p>Remove permanentemente sua conta e todos os dados</p>
                    </div>
                    <button onclick="confirmarExclusaoConta()" class="btn btn-danger">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="m22 11-5 5-3-3"></path>
                        </svg>
                        Excluir Conta
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <div id="bottom-nav-container"></div>

    <script>
        // Inicialização da página
        document.addEventListener('DOMContentLoaded', async () => {
            // Verificar se usuário está logado
            if (!checkAuth()) return;
            
            // Carregar componentes
            await loadNavbarComponent();
            await loadBottomNavComponent();
            setActiveNavItem('configuracoes');
            
            // Carregar dados do usuário
            carregarDadosUsuario();
            carregarInformacoesSistema();
            carregarPreferencias();
        });

        function carregarDadosUsuario() {
            const user = getCurrentUser();
            if (user) {
                document.getElementById('userName').value = user.name || '';
                document.getElementById('userEmail').value = user.email || '';
                document.getElementById('userPlano').value = user.plano || 'Basic';
                document.getElementById('ultimoLogin').textContent = new Date().toLocaleString('pt-BR');
            }
        }

        async function carregarInformacoesSystem() {
            try {
                const extintores = await carregarExtintores();
                document.getElementById('totalExtintoresInfo').textContent = extintores.length;
                
                // Calcular espaço usado (estimativa)
                const tamanhoEstimado = JSON.stringify(extintores).length;
                const tamanhoKB = (tamanhoEstimado / 1024).toFixed(2);
                document.getElementById('espacoUsado').textContent = `${tamanhoKB} KB`;
            } catch (error) {
                console.error('Erro ao carregar informações:', error);
            }
        }

        function carregarPreferencias() {
            // Carregar preferências salvas do localStorage
            const alertasEmail = localStorage.getItem('alertasEmail') === 'true';
            const alertasDias = localStorage.getItem('alertasDias') || '30';
            const autoBackup = localStorage.getItem('autoBackup') !== 'false';
            
            document.getElementById('alertasEmail').checked = alertasEmail;
            document.getElementById('alertasDias').value = alertasDias;
            document.getElementById('autoBackup').checked = autoBackup;
        }

        function salvarPreferencias() {
            const alertasEmail = document.getElementById('alertasEmail').checked;
            const alertasDias = document.getElementById('alertasDias').value;
            const autoBackup = document.getElementById('autoBackup').checked;
            
            localStorage.setItem('alertasEmail', alertasEmail);
            localStorage.setItem('alertasDias', alertasDias);
            localStorage.setItem('autoBackup', autoBackup);
            
            showNotification('Preferências salvas com sucesso!');
        }

        async function exportarDados() {
            try {
                const extintores = await carregarExtintores();
                const user = getCurrentUser();
                
                const dados = {
                    usuario: {
                        nome: user?.name,
                        email: user?.email,
                        plano: user?.plano
                    },
                    extintores: extintores,
                    exportadoEm: new Date().toISOString(),
                    versao: '1.0.0'
                };
                
                const dataStr = JSON.stringify(dados, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `backup-extintores-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                showNotification('Dados exportados com sucesso!');
            } catch (error) {
                console.error('Erro ao exportar dados:', error);
                showNotification('Erro ao exportar dados', 'error');
            }
        }

        async function importarDados(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const dados = JSON.parse(text);
                
                if (!dados.extintores || !Array.isArray(dados.extintores)) {
                    throw new Error('Formato de arquivo inválido');
                }
                
                const confirmacao = confirm(`Isto irá importar ${dados.extintores.length} extintor(es). Continuar?`);
                if (!confirmacao) return;
                
                // Salvar cada extintor
                let sucessos = 0;
                for (const extintor of dados.extintores) {
                    delete extintor.id; // Remove ID para criar novo
                    if (await salvarExtintor(extintor)) {
                        sucessos++;
                    }
                }
                
                showNotification(`${sucessos} extintor(es) importado(s) com sucesso!`);
                await carregarInformacoesSystem();
                
            } catch (error) {
                console.error('Erro ao importar dados:', error);
                showNotification('Erro ao importar dados. Verifique o formato do arquivo.', 'error');
            }
            
            // Limpar input
            event.target.value = '';
        }

        function limparCache() {
            if (confirm('Isto irá limpar o cache do navegador. Continuar?')) {
                localStorage.removeItem('ultimosDados');
                sessionStorage.clear();
                
                // Limpar cache do service worker se existir
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => {
                            caches.delete(name);
                        });
                    });
                }
                
                showNotification('Cache limpo com sucesso!');
            }
        }

        async function confirmarLimpezaTotal() {
            const confirmacao = confirm('ATENÇÃO: Isto irá apagar TODOS os extintores cadastrados. Esta ação não pode ser desfeita. Continuar?');
            if (!confirmacao) return;
            
            const confirmacao2 = confirm('Tem CERTEZA ABSOLUTA? Digite "CONFIRMAR" se quiser continuar:');
            if (!confirmacao2) return;
            
            try {
                const extintores = await carregarExtintores();
                let sucessos = 0;
                
                for (const extintor of extintores) {
                    if (await deletarExtintor(extintor.id)) {
                        sucessos++;
                    }
                }
                
                showNotification(`${sucessos} extintor(es) apagado(s)`);
                await carregarInformacoesSystem();
                
            } catch (error) {
                console.error('Erro ao apagar dados:', error);
                showNotification('Erro ao apagar dados', 'error');
            }
        }

        function confirmarExclusaoConta() {
            const confirmacao = confirm('ATENÇÃO: Isto irá excluir permanentemente sua conta e TODOS os dados. Esta ação não pode ser desfeita. Continuar?');
            if (!confirmacao) return;
            
            const email = prompt('Digite seu email para confirmar:');
            const user = getCurrentUser();
            
            if (email !== user?.email) {
                showNotification('Email não confere', 'error');
                return;
            }
            
            showNotification('Funcionalidade não implementada. Entre em contato para exclusão da conta.', 'warning');
        }

        // Event listeners
        document.getElementById('perfilForm').addEventListener('submit', (e) => {
            e.preventDefault();
            showNotification('Perfil atualizado!');
        });

        // Salvar preferências quando alteradas
        document.getElementById('alertasEmail').addEventListener('change', salvarPreferencias);
        document.getElementById('alertasDias').addEventListener('change', salvarPreferencias);
        document.getElementById('autoBackup').addEventListener('change', salvarPreferencias);

        // Chamar função de carregamento
        async function carregarInformacoesSystem() {
            await carregarInformacoesSystem();
        }
    </script>

    <style>
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .card-header h3 {
            margin: 0;
            color: var(--text-primary);
        }

        .configuracao-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .configuracao-item:last-child {
            border-bottom: none;
        }

        .config-info {
            flex: 1;
        }

        .config-info label {
            font-weight: 500;
            color: var(--text-primary);
            display: block;
            margin-bottom: 0.25rem;
        }

        .config-info small {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .data-actions,
        .danger-actions {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .action-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
        }

        .action-info {
            flex: 1;
            margin-right: 1rem;
        }

        .action-info h4 {
            margin: 0 0 0.5rem 0;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .action-info p {
            margin: 0;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .sistema-info {
            display: grid;
            gap: 1rem;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }

        .info-label {
            font-weight: 500;
            color: var(--text-secondary);
        }

        .info-value {
            color: var(--text-primary);
            font-weight: 600;
        }

        .danger-zone {
            border: 1px solid var(--danger-color);
        }

        .danger-zone .card-header h3 {
            color: var(--danger-color);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
            border: none;
        }

        .btn-danger:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        @media (max-width: 640px) {
            .configuracao-item,
            .action-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .action-info {
                margin-right: 0;
            }

            .info-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }
    </style>
</body>
</html>
