<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#121212">
    <title>Configurações - Controle de Extintores</title>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/common.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/navigation.css">
    <link rel="stylesheet" href="../css/dropdowns.css">
    <link rel="stylesheet" href="../css/pwa.css">
</head>
<body>
    <!-- Navigation Bar -->
    <div id="navbar-container"></div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="screen-header">
            <h1>Configurações</h1>
            <p>Gerencie suas preferências e dados</p>
        </div>
        <!-- Botão para Inspecionar por QR Code -->
        <div style="display: flex; justify-content: flex-end; margin-bottom: 1.5rem;">
            <button id="btn-inspecao-qr" class="btn btn-primary" style="font-size:1.1rem; border-radius:8px; background:#d32f2f; color:#fff;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle; margin-right:0.5em;"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                Inspecionar por QR Code
            </button>
        </div>

        <!-- Modal de checklist de inspeção fixo -->
        <div id="modal-checklist-inspecao" class="modal-overlay" style="display:none;">
            <div class="modal-content">
                <h3 id="titulo-modal-checklist" style="color:#d32f2f; font-size:1.3rem; margin-bottom:0.7em;">Inspeção do Extintor</h3>
                <div style="font-weight:500;color:#444;margin-bottom:0.2em;">
                    <span style="color:#888;">Extintor:</span> <span id="modal-checklist-numero" style="color:#d32f2f;font-weight:700;">-</span>
                </div>
                <div style="font-weight:500;color:#444;margin-bottom:0.7em;">
                    <span style="color:#888;">Local:</span> <span id="modal-checklist-local" style="color:#374151;font-weight:700;">-</span>
                </div>
                <form id="form-checklist-inspecao">
                    <div style="margin-bottom:12px;"><label><input type="checkbox" name="sinalizacao" required> Sinalização visível</label></div>
                    <div style="margin-bottom:12px;"><label><input type="checkbox" name="acesso" required> Acesso desobstruído</label></div>
                    <div style="margin-bottom:12px;"><label><input type="checkbox" name="lacre" required> Lacre intacto</label></div>
                    <div style="margin-bottom:12px;"><label><input type="checkbox" name="manometro" required> Manômetro na faixa verde</label></div>
                    <div style="margin-bottom:12px;"><label><input type="checkbox" name="danos" required> Sem danos aparentes</label></div>
                    <div style="margin-bottom:12px;"><textarea name="observacoes" placeholder="Observações" style="width:100%;"></textarea></div>
                    <button type="submit" class="btn btn-primary">Salvar Inspeção</button>
                    <button type="button" id="fechar-modal-checklist" class="btn btn-secondary" style="margin-left:8px;">Fechar</button>
                </form>
            </div>
        </div>
        
        <!-- Perfil do Usuário -->
        <div class="card" id="perfil">
            <div class="card-header">
                <h3>Perfil do Usuário</h3>
            </div>
            
            <form id="perfilForm">
                <div class="form-group">
                    <label for="userName">Nome</label>
                    <input type="text" id="userName" placeholder="Seu nome completo">
                </div>
                <div class="form-group">
                    <label for="userEmail">Email</label>
                    <input type="email" id="userEmail" placeholder="seu@email.com" readonly>
                    <small class="form-help">O email não pode ser alterado</small>
                </div>
                <div class="form-group">
                    <label for="userPlano">Plano</label>
                    <input type="text" id="userPlano" readonly>
                    <small class="form-help">Para alterar o plano, entre em contato</small>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20,6 9,17 4,12"></polyline>
                    </svg>
                    Salvar Perfil
                </button>
            </form>
        </div>

        <!-- Preferências -->
        <div class="card">
            <div class="card-header">
                <h3>Preferências</h3>
            </div>
            
            <div class="configuracao-item">
                <div class="config-info">
                    <label for="alertasEmail">Alertas por Email</label>
                    <small>Receber notificações de vencimento por email</small>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="alertasEmail">
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="configuracao-item">
                <div class="config-info">
                    <label for="alertasDias">Antecedência dos Alertas</label>
                    <small>Quantos dias antes do vencimento alertar</small>
                </div>
                <select id="alertasDias" class="form-select">
                    <option value="7">7 dias</option>
                    <option value="15">15 dias</option>
                    <option value="30" selected>30 dias</option>
                    <option value="60">60 dias</option>
                </select>
            </div>
            
            <div class="configuracao-item">
                <div class="config-info">
                    <label for="autoBackup">Backup Automático</label>
                    <small>Fazer backup automático dos dados</small>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="autoBackup" checked>
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <!-- Gerenciamento de Dados -->
        <div class="card">
            <div class="card-header">
                <h3>Gerenciamento de Dados</h3>
            </div>
            
            <div class="data-actions">
                <div class="action-item">
                    <div class="action-info">
                        <h4>Exportar Dados</h4>
                        <p>Baixar todos os seus dados em formato JSON</p>
                    </div>
                    <button onclick="exportarDados()" class="btn btn-secondary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7,10 12,15 17,10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Exportar
                    </button>
                </div>
                
                <div class="action-item">
                    <div class="action-info">
                        <h4>Importar Dados</h4>
                        <p>Importar dados de um backup anterior</p>
                    </div>
                    <label for="importFile" class="btn btn-secondary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17,8 12,3 7,8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        Importar
                    </label>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importarDados(event)">
                </div>
                
                <div class="action-item">
                    <div class="action-info">
                        <h4>Limpar Cache</h4>
                        <p>Limpar dados temporários e cache do navegador</p>
                    </div>
                    <button onclick="limparCache()" class="btn btn-secondary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18l-1.5 9a2 2 0 0 1-2 2H6.5a2 2 0 0 1-2-2L3 6Z"></path>
                            <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            <line x1="10" y1="11" x2="10" y2="17"></line>
                            <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                        Limpar Cache
                    </button>
                </div>
            </div>
        </div>

        <!-- Informações do Sistema -->
        <div class="card">
            <div class="card-header">
                <h3>Informações do Sistema</h3>
            </div>
            
            <div class="sistema-info">
                <div class="info-item">
                    <span class="info-label">Versão:</span>
                    <span class="info-value">1.0.0</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Último Login:</span>
                    <span class="info-value" id="ultimoLogin">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Total de Extintores:</span>
                    <span class="info-value" id="totalExtintoresInfo">0</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Espaço Usado:</span>
                    <span class="info-value" id="espacoUsado">-</span>
                </div>
            </div>
        </div>

        <!-- Zona Perigosa -->
        <div class="card danger-zone">
            <div class="card-header">
                <h3>Zona Perigosa</h3>
            </div>
            
            <div class="danger-actions">
                <div class="action-item">
                    <div class="action-info">
                        <h4>Apagar Todos os Dados</h4>
                        <p>Remove permanentemente todos os extintores cadastrados</p>
                    </div>
                    <button onclick="confirmarLimpezaTotal()" class="btn btn-danger">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18l-1.5 9a2 2 0 0 1-2 2H6.5a2 2 0 0 1-2-2L3 6Z"></path>
                            <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                        Apagar Tudo
                    </button>
                </div>
                
                <div class="action-item">
                    <div class="action-info">
                        <h4>Excluir Conta</h4>
                        <p>Remove permanentemente sua conta e todos os dados</p>
                    </div>
                    <button onclick="confirmarExclusaoConta()" class="btn btn-danger">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="m22 11-5 5-3-3"></path>
                        </svg>
                        Excluir Conta
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <div id="bottom-nav-container"></div>

    <script>
    // Novo fluxo: abrir modal-checklist-inspecao, preencher dados, salvar inspeção e fechar/resetar
    document.addEventListener('DOMContentLoaded', function() {
        var btnQr = document.getElementById('btn-inspecao-qr');
        var modalChecklist = document.getElementById('modal-checklist-inspecao');
        var fecharChecklist = document.getElementById('fechar-modal-checklist');
        var numeroSpan = document.getElementById('modal-checklist-numero');
        var localSpan = document.getElementById('modal-checklist-local');
        var formChecklist = document.getElementById('form-checklist-inspecao');

        function abrirModalInspecao(numero, local) {
            numeroSpan.textContent = numero || '-';
            localSpan.textContent = local || '-';
            formChecklist.reset();
            modalChecklist.style.display = 'flex';
        }

        if (btnQr && modalChecklist && numeroSpan && localSpan && fecharChecklist && formChecklist) {
            btnQr.onclick = function() {
                const numero = prompt('Digite o número do extintor para inspecionar:');
                const local = prompt('Digite o local do extintor:');
                if (numero) abrirModalInspecao(numero, local);
            };
            fecharChecklist.onclick = function() {
                modalChecklist.style.display = 'none';
                formChecklist.reset();
            };
            formChecklist.onsubmit = function(e) {
                e.preventDefault();
                const dados = Object.fromEntries(new FormData(formChecklist));
                alert('Inspeção salva!\n' + JSON.stringify(dados, null, 2));
                modalChecklist.style.display = 'none';
                formChecklist.reset();
            };
        }
    });
    </script>

    <script>
        // Inicialização da página
        document.addEventListener('DOMContentLoaded', async () => {
            // Verificar se usuário está logado
            if (!checkAuth()) return;
            
            // Carregar componentes
            await loadNavbarComponent();
            await loadBottomNavComponent();
            setActiveNavItem('configuracoes');
            
            // Carregar dados do usuário
            await carregarDadosUsuario();
            carregarInformacoesSystem();
            carregarPreferencias();
            
            // Verificar se deve scrollar para o perfil
            if (window.location.hash === '#perfil') {
                setTimeout(() => {
                    const perfilSection = document.getElementById('perfil');
                    if (perfilSection) {
                        perfilSection.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' 
                        });
                        // Adicionar destaque visual temporário
                        perfilSection.style.boxShadow = '0 0 20px rgba(239, 68, 68, 0.3)';
                        setTimeout(() => {
                            perfilSection.style.boxShadow = '';
                        }, 2000);
                    }
                }, 500);
            }
        });

        async function carregarDadosUsuario() {
            const user = getCurrentUser();
            if (!user) return;
            
            try {
                // Tentar carregar dados atualizados do Supabase
                const response = await fetch(`https://japgbufsqbjfkbkrncgg.supabase.co/rest/v1/users?id=eq.${user.id}&select=*`, {
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImphcGdidWZzcWJqZmtia3JuY2dnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0OTg3NTksImV4cCI6MjA3MDA3NDc1OX0.AIc0koiJoLrRoFEhvV8qfskpL5ffA-l35cvGNGTLlOs',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImphcGdidWZzcWJqZmtia3JuY2dnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0OTg3NTksImV4cCI6MjA3MDA3NDc1OX0.AIc0koiJoLrRoFEhvV8qfskpL5ffA-l35cvGNGTLlOs'
                    }
                });
                
                if (response.ok) {
                    const userData = await response.json();
                    if (userData && userData.length > 0) {
                        const userFromDB = userData[0];
                        
                        // Atualizar sessionStorage com dados do banco
                        const updatedUser = { ...user, ...userFromDB };
                        sessionStorage.setItem('currentUser', JSON.stringify(updatedUser));
                        
                        // Preencher formulário com dados do banco
                        document.getElementById('userName').value = userFromDB.name || user.email?.split('@')[0] || '';
                        document.getElementById('userEmail').value = userFromDB.email || user.email || '';
                        document.getElementById('userPlano').value = userFromDB.plan || 'Starter';
                        
                        console.log('✅ Dados do usuário carregados do Supabase');
                        return;
                    }
                }
                
                // Fallback: usar dados do sessionStorage
                console.warn('⚠️ Usando dados locais (não encontrado no Supabase)');
                
            } catch (error) {
                console.warn('⚠️ Erro ao carregar do Supabase, usando dados locais:', error);
            }
            
            // Fallback: dados locais
            document.getElementById('userName').value = user.name || user.email?.split('@')[0] || '';
            document.getElementById('userEmail').value = user.email || '';
            document.getElementById('userPlano').value = user.subscription || 'Starter';
            document.getElementById('ultimoLogin').textContent = new Date().toLocaleString('pt-BR');
        }

        async function carregarInformacoesSystem() {
            try {
                const extintores = await carregarExtintores();
                document.getElementById('totalExtintoresInfo').textContent = extintores.length;
                
                // Calcular espaço usado (estimativa)
                const tamanhoEstimado = JSON.stringify(extintores).length;
                const tamanhoKB = (tamanhoEstimado / 1024).toFixed(2);
                document.getElementById('espacoUsado').textContent = `${tamanhoKB} KB`;
            } catch (error) {
                console.error('Erro ao carregar informações:', error);
                document.getElementById('totalExtintoresInfo').textContent = 'Erro';
                document.getElementById('espacoUsado').textContent = 'Erro';
            }
        }

        function carregarPreferencias() {
            // Carregar preferências salvas do localStorage
            const alertasEmail = localStorage.getItem('alertasEmail') === 'true';
            const alertasDias = localStorage.getItem('alertasDias') || '30';
            const autoBackup = localStorage.getItem('autoBackup') !== 'false';
            
            document.getElementById('alertasEmail').checked = alertasEmail;
            document.getElementById('alertasDias').value = alertasDias;
            document.getElementById('autoBackup').checked = autoBackup;
        }

        function salvarPreferencias() {
            const alertasEmail = document.getElementById('alertasEmail').checked;
            const alertasDias = document.getElementById('alertasDias').value;
            const autoBackup = document.getElementById('autoBackup').checked;
            
            localStorage.setItem('alertasEmail', alertasEmail);
            localStorage.setItem('alertasDias', alertasDias);
            localStorage.setItem('autoBackup', autoBackup);
            
            showNotification('Preferências salvas com sucesso!');
        }

        async function exportarDados() {
            try {
                const extintores = await carregarExtintores();
                const user = getCurrentUser();
                
                const dados = {
                    usuario: {
                        nome: user?.name,
                        email: user?.email,
                        plano: user?.plano
                    },
                    extintores: extintores,
                    exportadoEm: new Date().toISOString(),
                    versao: '1.0.0'
                };
                
                const dataStr = JSON.stringify(dados, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `backup-extintores-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                showNotification('Dados exportados com sucesso!');
            } catch (error) {
                console.error('Erro ao exportar dados:', error);
                showNotification('Erro ao exportar dados', 'error');
            }
        }

        async function importarDados(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const dados = JSON.parse(text);
                
                if (!dados.extintores || !Array.isArray(dados.extintores)) {
                    throw new Error('Formato de arquivo inválido');
                }
                
                const confirmacao = confirm(`Isto irá importar ${dados.extintores.length} extintor(es). Continuar?`);
                if (!confirmacao) return;
                
                const user = getCurrentUser();
                if (!user) {
                    showNotification('Usuário não encontrado', 'error');
                    return;
                }
                
                // Salvar cada extintor usando a API Supabase
                let sucessos = 0;
                for (const extintor of dados.extintores) {
                    try {
                        // Preparar dados do extintor
                        const novoExtintor = {
                            numero: extintor.numero,
                            local: extintor.local,
                            tipo: extintor.tipo,
                            peso: extintor.peso,
                            validade: extintor.validade,
                            hidro: extintor.hidro,
                            observacoes: extintor.observacoes || null,
                            user_id: user.id
                        };
                        
                        const response = await fetch('https://japgbufsqbjfkbkrncgg.supabase.co/rest/v1/extintores', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImphcGdidWZzcWJqZmtia3JuY2dnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0OTg3NTksImV4cCI6MjA3MDA3NDc1OX0.AIc0koiJoLrRoFEhvV8qfskpL5ffA-l35cvGNGTLlOs',
                                'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImphcGdidWZzcWJqZmtia3JuY2dnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0OTg3NTksImV4cCI6MjA3MDA3NDc1OX0.AIc0koiJoLrRoFEhvV8qfskpL5ffA-l35cvGNGTLlOs',
                                'Prefer': 'return=minimal'
                            },
                            body: JSON.stringify(novoExtintor)
                        });
                        
                        if (response.ok) {
                            sucessos++;
                        }
                        
                    } catch (extintorError) {
                        console.error('Erro ao importar extintor:', extintorError);
                    }
                }
                
                showNotification(`${sucessos} extintor(es) importado(s) com sucesso!`);
                await carregarInformacoesSystem();
                
            } catch (error) {
                console.error('Erro ao importar dados:', error);
                showNotification('Erro ao importar dados. Verifique o formato do arquivo.', 'error');
            }
            
            // Limpar input
            event.target.value = '';
        }

        function limparCache() {
            if (confirm('Isto irá limpar o cache do navegador. Continuar?')) {
                localStorage.removeItem('ultimosDados');
                sessionStorage.clear();
                
                // Limpar cache do service worker se existir
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => {
                            caches.delete(name);
                        });
                    });
                }
                
                showNotification('Cache limpo com sucesso!');
            }
        }

        async function confirmarLimpezaTotal() {
            const confirmacao = confirm('ATENÇÃO: Isto irá apagar TODOS os extintores cadastrados. Esta ação não pode ser desfeita. Continuar?');
            if (!confirmacao) return;
            
            const confirmacaoTexto = prompt('Digite "CONFIRMAR" para prosseguir:');
            if (confirmacaoTexto !== 'CONFIRMAR') {
                showNotification('Operação cancelada', 'warning');
                return;
            }
            
            try {
                const user = getCurrentUser();
                if (!user) {
                    showNotification('Usuário não encontrado', 'error');
                    return;
                }
                
                // Buscar e deletar todos os extintores do usuário
                const response = await fetch(`https://japgbufsqbjfkbkrncgg.supabase.co/rest/v1/extintores?user_id=eq.${user.id}`, {
                    method: 'DELETE',
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImphcGdidWZzcWJqZmtia3JuY2dnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0OTg3NTksImV4cCI6MjA3MDA3NDc1OX0.AIc0koiJoLrRoFEhvV8qfskpL5ffA-l35cvGNGTLlOs',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImphcGdidWZzcWJqZmtia3JuY2dnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0OTg3NTksImV4cCI6MjA3MDA3NDc1OX0.AIc0koiJoLrRoFEhvV8qfskpL5ffA-l35cvGNGTLlOs',
                        'Prefer': 'return=minimal'
                    }
                });
                
                if (response.ok) {
                    showNotification('Todos os extintores foram apagados com sucesso!');
                    await carregarInformacoesSystem();
                } else {
                    throw new Error('Erro ao apagar extintores');
                }
                
            } catch (error) {
                console.error('Erro ao apagar dados:', error);
                showNotification('Erro ao apagar dados', 'error');
            }
        }

        function confirmarExclusaoConta() {
            const confirmacao = confirm('ATENÇÃO: Isto irá excluir permanentemente sua conta e TODOS os dados. Esta ação não pode ser desfeita. Continuar?');
            if (!confirmacao) return;
            
            const email = prompt('Digite seu email para confirmar:');
            const user = getCurrentUser();
            
            if (email !== user?.email) {
                showNotification('Email não confere', 'error');
                return;
            }
            
            showNotification('Funcionalidade não implementada. Entre em contato para exclusão da conta.', 'warning');
        }

        // Event listeners
        document.getElementById('perfilForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const user = getCurrentUser();
                const novoNome = document.getElementById('userName').value.trim();
                
                if (!novoNome) {
                    showNotification('Nome é obrigatório', 'error');
                    return;
                }
                
                // Mostrar loading
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<span>Salvando...</span>';
                submitBtn.disabled = true;
                
                // Atualizar no Supabase
                const response = await fetch(`https://japgbufsqbjfkbkrncgg.supabase.co/rest/v1/users?id=eq.${user.id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImphcGdidWZzcWJqZmtia3JuY2dnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0OTg3NTksImV4cCI6MjA3MDA3NDc1OX0.AIc0koiJoLrRoFEhvV8qfskpL5ffA-l35cvGNGTLlOs',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImphcGdidWZzcWJqZmtia3JuY2dnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0OTg3NTksImV4cCI6MjA3MDA3NDc1OX0.AIc0koiJoLrRoFEhvV8qfskpL5ffA-l35cvGNGTLlOs',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({
                        name: novoNome,
                        updated_at: new Date().toISOString()
                    })
                });
                
                if (response.ok) {
                    // Atualizar no sessionStorage local também
                    user.name = novoNome;
                    sessionStorage.setItem('currentUser', JSON.stringify(user));
                    
                    showNotification('Perfil atualizado com sucesso no Supabase!');
                } else {
                    // Se falhar no Supabase, tentar salvar pelo menos localmente
                    console.warn('Erro ao salvar no Supabase, salvando localmente:', response.status);
                    user.name = novoNome;
                    sessionStorage.setItem('currentUser', JSON.stringify(user));
                    
                    showNotification('Perfil atualizado localmente (erro no servidor)', 'warning');
                }
                
            } catch (error) {
                console.error('Erro ao salvar perfil:', error);
                
                // Fallback: salvar pelo menos localmente
                try {
                    const user = getCurrentUser();
                    const novoNome = document.getElementById('userName').value.trim();
                    user.name = novoNome;
                    sessionStorage.setItem('currentUser', JSON.stringify(user));
                    
                    showNotification('Perfil salvo localmente (sem conexão com servidor)', 'warning');
                } catch (localError) {
                    showNotification('Erro ao salvar perfil', 'error');
                }
            } finally {
                // Restaurar botão
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // Salvar preferências quando alteradas
        document.getElementById('alertasEmail').addEventListener('change', salvarPreferencias);
        document.getElementById('alertasDias').addEventListener('change', salvarPreferencias);
        document.getElementById('autoBackup').addEventListener('change', salvarPreferencias);

        // Chamar função de carregamento
        async function carregarInformacoesSystem() {
            // Coloque aqui o código para buscar e exibir informações do sistema
        }
    </script>

    <style>
        /* Modal de inspeção */
        .modal-overlay {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: #fff;
            padding: 24px;
            border-radius: 12px;
            max-width: 410px;
            margin: auto;
            width: 95vw;
            box-shadow: 0 4px 32px rgba(0,0,0,0.18);
            animation: modalIn 0.18s cubic-bezier(.4,1.3,.6,1) both;
        }
        @keyframes modalIn {
            from { opacity: 0; transform: translateY(40px) scale(0.98); }
            to { opacity: 1; transform: none; }
        }
    .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .card-header h3 {
            margin: 0;
            color: var(--text-primary);
        }

        .configuracao-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .configuracao-item:last-child {
            border-bottom: none;
        }

        .config-info {
            flex: 1;
        }

        .config-info label {
            font-weight: 500;
            color: var(--text-primary);
            display: block;
            margin-bottom: 0.25rem;
        }

        .config-info small {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .data-actions,
        .danger-actions {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .action-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
        }

        .action-info {
            flex: 1;
            margin-right: 1rem;
        }

        .action-info h4 {
            margin: 0 0 0.5rem 0;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .action-info p {
            margin: 0;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .sistema-info {
            display: grid;
            gap: 1rem;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }

        .info-label {
            font-weight: 500;
            color: var(--text-secondary);
        }

        .info-value {
            color: var(--text-primary);
            font-weight: 600;
        }

        .danger-zone {
            border: 1px solid var(--danger-color);
        }

        .danger-zone .card-header h3 {
            color: var(--danger-color);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
            border: none;
        }

        .btn-danger:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        /* Estilo para modais de confirmação */
        .emergency-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .emergency-modal-content {
            background: var(--bg-primary);
            padding: 2rem;
            border-radius: var(--radius-lg);
            max-width: 400px;
            width: 90%;
            text-align: center;
            border: 2px solid var(--danger-color);
        }

        .emergency-modal-content h3 {
            color: var(--danger-color);
            margin-bottom: 1rem;
        }

        .emergency-btn {
            margin-top: 1.5rem;
            padding: 0.75rem 1.5rem;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 500;
        }

        .emergency-btn:hover {
            background: var(--primary-dark);
        }

        @media (max-width: 640px) {
            .configuracao-item,
            .action-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .action-info {
                margin-right: 0;
            }

            .info-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }
    </style>
</body>
</html>
