<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Rápido - Controle de Usuários</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 2rem auto;
            padding: 1rem;
            background: #f5f5f5;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin: 0.5rem;
        }
        .btn:hover { background: #0056b3; }
        .btn.success { background: #28a745; }
        .btn.danger { background: #dc3545; }
        #log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
            margin: 1rem 0;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>🧪 Teste Rápido - Controle de Usuários</h1>
        
        <div>
            <button class="btn success" onclick="executarTeste()">🚀 Executar Teste</button>
            <button class="btn" onclick="limparLog()">🧹 Limpar Log</button>
            <button class="btn danger" onclick="resetarSessoes()">🔄 Reset Sessões</button>
        </div>
        
        <div id="log">Clique em "Executar Teste" para iniciar...</div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Configuração do Supabase
        const SUPABASE_URL = 'https://svgtqmhgxdvykxdrcunw.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN2Z3RxbWhneGR2eWt4ZHJjdW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzM5Mjk5MjQsImV4cCI6MjA0OTUwNTkyNH0.jDWYBLUTwj8H8EJo7fMTWxBOvxBRb9OlzNfGKMOQqY8';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            document.getElementById('log').innerText += `[${timestamp}] ${message}\n`;
            document.getElementById('log').scrollTop = document.getElementById('log').scrollHeight;
        }
        
        function limparLog() {
            document.getElementById('log').innerText = '';
        }
        
        function resetarSessoes() {
            localStorage.removeItem('globalSessions');
            sessionStorage.removeItem('userSession');
            log('🔄 Todas as sessões foram resetadas');
        }
        
        async function executarTeste() {
            log('🧪 INICIANDO TESTE DO CONTROLE DE USUÁRIOS');
            log('==========================================');
            
            try {
                // Passo 1: Setup do usuário de teste
                log('📝 1. Configurando usuário de teste...');
                const testUser = {
                    id: 'test-user-123',
                    email: 'starter@test-plans.com',
                    user_metadata: { plan: 'starter' }
                };
                localStorage.setItem('supabase_user', JSON.stringify(testUser));
                log('✅ Usuário configurado: starter@test-plans.com (Plano Starter - 2 usuários)');
                
                // Passo 2: Reset completo
                log('🧹 2. Limpando sessões existentes...');
                resetarSessoes();
                
                // Passo 3: Simular sessão atual
                log('👤 3. Simulando primeira sessão ativa...');
                const sessionId1 = 'session_1_' + Date.now();
                const globalSessions = {
                    [sessionId1]: {
                        userId: testUser.id,
                        email: testUser.email,
                        plan: 'starter',
                        loginTime: new Date().toISOString(),
                        lastActivity: new Date().toISOString(),
                        sessionId: sessionId1
                    }
                };
                localStorage.setItem('globalSessions', JSON.stringify(globalSessions));
                log('✅ Primeira sessão criada');
                
                // Passo 4: Verificar limite atual
                log('📊 4. Verificando usuários ativos...');
                let activeUsers = await getActiveUserCount();
                log(`📈 Usuários ativos: ${activeUsers} / 2`);
                
                // Passo 5: Testar se pode adicionar mais um usuário
                log('🔍 5. Testando se pode adicionar segundo usuário...');
                let canAdd = await canAddUser();
                log(`✅ Pode adicionar 2º usuário: ${canAdd ? 'SIM' : 'NÃO'}`);
                
                if (!canAdd) {
                    log('❌ ERRO: Deveria permitir 2º usuário no plano Starter!');
                    return;
                }
                
                // Passo 6: Adicionar segundo usuário
                log('👥 6. Adicionando segundo usuário...');
                const sessionId2 = 'session_2_' + Date.now();
                const sessions = JSON.parse(localStorage.getItem('globalSessions') || '{}');
                sessions[sessionId2] = {
                    userId: 'test-user-2',
                    email: 'usuario2@test.com',
                    plan: 'starter',
                    loginTime: new Date().toISOString(),
                    lastActivity: new Date().toISOString(),
                    sessionId: sessionId2
                };
                localStorage.setItem('globalSessions', JSON.stringify(sessions));
                
                activeUsers = await getActiveUserCount();
                log(`📈 Usuários ativos agora: ${activeUsers} / 2`);
                
                // Passo 7: Testar limite atingido
                log('🚫 7. Testando limite atingido (3º usuário)...');
                canAdd = await canAddUser();
                log(`🔒 Pode adicionar 3º usuário: ${canAdd ? 'SIM' : 'NÃO'}`);
                
                if (canAdd) {
                    log('❌ ERRO: NÃO deveria permitir 3º usuário no plano Starter!');
                    return;
                } else {
                    log('✅ PERFEITO: Sistema bloqueou corretamente o 3º usuário!');
                }
                
                // Passo 8: Testar expiração
                log('⏰ 8. Testando expiração de sessões...');
                const expiredTime = new Date(Date.now() - 35 * 60 * 1000); // 35 min atrás
                sessions['expired_session'] = {
                    userId: 'expired-user',
                    email: 'expirado@test.com',
                    plan: 'starter',
                    loginTime: expiredTime.toISOString(),
                    lastActivity: expiredTime.toISOString(),
                    sessionId: 'expired_session'
                };
                localStorage.setItem('globalSessions', JSON.stringify(sessions));
                
                // Contar usuários (isso deve limpar sessões expiradas)
                activeUsers = await getActiveUserCount();
                log(`🧹 Usuários após limpeza automática: ${activeUsers} / 2`);
                
                // Verificar se sessão expirada foi removida
                const cleanedSessions = JSON.parse(localStorage.getItem('globalSessions') || '{}');
                const expired = cleanedSessions.hasOwnProperty('expired_session');
                log(`🗑️ Sessão expirada removida: ${expired ? 'NÃO' : 'SIM'}`);
                
                // Resultado final
                log('\n🎉 RESULTADO FINAL:');
                log('===================');
                log('✅ Limite de usuários funcionando');
                log('✅ Bloqueio do 3º usuário OK');
                log('✅ Limpeza de sessões expiradas OK');
                log('🚀 SISTEMA DE CONTROLE DE USUÁRIOS FUNCIONANDO PERFEITAMENTE!');
                
            } catch (error) {
                log(`❌ ERRO NO TESTE: ${error.message}`);
                console.error(error);
            }
        }
        
        // Funções de validação simplificadas
        async function getActiveUserCount() {
            try {
                const sessions = JSON.parse(localStorage.getItem('globalSessions') || '{}');
                const thirtyMinutesAgo = new Date(Date.now() - 30 * 60 * 1000);
                
                let activeCount = 0;
                const activeSessions = {};
                
                for (const [sessionId, sessionData] of Object.entries(sessions)) {
                    const lastActivity = new Date(sessionData.lastActivity);
                    
                    if (lastActivity > thirtyMinutesAgo) {
                        activeCount++;
                        activeSessions[sessionId] = sessionData;
                    }
                }
                
                // Salvar apenas sessões ativas
                localStorage.setItem('globalSessions', JSON.stringify(activeSessions));
                
                return activeCount;
            } catch (error) {
                console.error('Erro ao contar usuários ativos:', error);
                return 0;
            }
        }
        
        async function canAddUser() {
            const planLimits = {
                starter: 2,
                professional: 10,
                enterprise: -1 // ilimitado
            };
            
            const user = JSON.parse(localStorage.getItem('supabase_user') || '{}');
            const userPlan = user.user_metadata?.plan || 'starter';
            const limit = planLimits[userPlan];
            
            if (limit === -1) return true; // Enterprise = ilimitado
            
            const activeUsers = await getActiveUserCount();
            return activeUsers < limit;
        }
    </script>
</body>
</html>
