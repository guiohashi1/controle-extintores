<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Supabase - Controle de Extintores</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #0f172a;
            color: #f8fafc;
            padding: 2rem;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #1e293b;
            border-radius: 1rem;
            padding: 2rem;
            border: 1px solid #475569;
        }
        h1 {
            text-align: center;
            color: #ef4444;
            margin-bottom: 2rem;
        }
        .test-section {
            background: #334155;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid #ef4444;
        }
        .test-section h3 {
            margin-top: 0;
            color: #cbd5e1;
        }
        button {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            margin: 0.5rem 0.5rem 0.5rem 0;
            font-weight: 500;
            transition: background 0.2s;
        }
        button:hover {
            background: #dc2626;
        }
        .result {
            background: #475569;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
        .info { color: #3b82f6; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî• Teste de Configura√ß√£o Supabase</h1>
        
        <div class="test-section">
            <h3>1. Verificar Configura√ß√£o</h3>
            <p>Testa se as credenciais do Supabase est√£o corretas</p>
            <button onclick="testarConfiguracao()">Testar Configura√ß√£o</button>
            <div id="config-result" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>2. Testar Conex√£o</h3>
            <p>Verifica se consegue conectar com o banco de dados</p>
            <button onclick="testarConexao()">Testar Conex√£o</button>
            <div id="conexao-result" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>3. Verificar Tabelas</h3>
            <p>Verifica se as tabelas existem no banco</p>
            <button onclick="verificarTabelas()">Verificar Tabelas</button>
            <div id="tabelas-result" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>4. Testar Login Demo</h3>
            <p>Testa o login com as credenciais demo</p>
            <button onclick="testarLoginDemo()">Testar Login</button>
            <div id="login-result" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>5. Listar Usu√°rios</h3>
            <p>Lista todos os usu√°rios cadastrados</p>
            <button onclick="listarUsuarios()">Listar Usu√°rios</button>
            <div id="usuarios-result" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>6. Teste Completo</h3>
            <p>Executa todos os testes em sequ√™ncia</p>
            <button onclick="executarTodosOsTestes()">Executar Todos</button>
            <div id="completo-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type;
            
            element.innerHTML += `<span class="${colorClass}">[${timestamp}] ${message}</span>\n`;
            element.scrollTop = element.scrollHeight;
        }

        function clearLog(elementId) {
            const element = document.getElementById(elementId);
            element.innerHTML = '';
            element.style.display = 'none';
        }

        async function testarConfiguracao() {
            clearLog('config-result');
            
            try {
                log('config-result', 'Verificando configura√ß√£o...', 'info');
                
                if (!window.SUPABASE_CONFIG) {
                    log('config-result', '‚ùå SUPABASE_CONFIG n√£o encontrado', 'error');
                    return;
                }
                
                log('config-result', `‚úÖ URL: ${SUPABASE_CONFIG.url}`, 'success');
                log('config-result', `‚úÖ API Key: ${SUPABASE_CONFIG.anonKey.substring(0, 20)}...`, 'success');
                
                if (!window.supabase) {
                    log('config-result', '‚ùå Objeto supabase n√£o encontrado', 'error');
                    return;
                }
                
                log('config-result', '‚úÖ Objeto supabase criado com sucesso', 'success');
                log('config-result', '‚úÖ Configura√ß√£o OK!', 'success');
                
            } catch (error) {
                log('config-result', `‚ùå Erro na configura√ß√£o: ${error.message}`, 'error');
            }
        }

        async function testarConexao() {
            clearLog('conexao-result');
            
            try {
                log('conexao-result', 'Testando conex√£o com Supabase...', 'info');
                
                const response = await fetch(`${SUPABASE_CONFIG.url}/rest/v1/`, {
                    headers: {
                        'apikey': SUPABASE_CONFIG.anonKey,
                        'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                    }
                });
                
                if (response.ok) {
                    log('conexao-result', '‚úÖ Conex√£o estabelecida com sucesso!', 'success');
                    log('conexao-result', `Status: ${response.status}`, 'info');
                } else {
                    log('conexao-result', `‚ùå Erro na conex√£o: ${response.status}`, 'error');
                    log('conexao-result', `Detalhes: ${await response.text()}`, 'error');
                }
                
            } catch (error) {
                log('conexao-result', `‚ùå Erro de rede: ${error.message}`, 'error');
            }
        }

        async function verificarTabelas() {
            clearLog('tabelas-result');
            
            try {
                log('tabelas-result', 'Verificando tabelas no banco...', 'info');
                
                const tabelas = ['users', 'extintores', 'inspecoes'];
                
                for (const tabela of tabelas) {
                    try {
                        const response = await fetch(`${SUPABASE_CONFIG.url}/rest/v1/${tabela}?limit=1`, {
                            headers: {
                                'apikey': SUPABASE_CONFIG.anonKey,
                                'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                            }
                        });
                        
                        if (response.ok) {
                            log('tabelas-result', `‚úÖ Tabela "${tabela}" existe`, 'success');
                        } else {
                            log('tabelas-result', `‚ùå Tabela "${tabela}" n√£o encontrada (${response.status})`, 'error');
                        }
                    } catch (error) {
                        log('tabelas-result', `‚ùå Erro ao verificar tabela "${tabela}": ${error.message}`, 'error');
                    }
                }
                
            } catch (error) {
                log('tabelas-result', `‚ùå Erro geral: ${error.message}`, 'error');
            }
        }

        async function testarLoginDemo() {
            clearLog('login-result');
            
            try {
                log('login-result', 'Testando login com credenciais demo...', 'info');
                log('login-result', 'Email: demo@exemplo.com', 'info');
                log('login-result', 'Senha: 123456', 'info');
                
                const result = await supabase.login('demo@exemplo.com', '123456');
                
                log('login-result', `Resultado: ${JSON.stringify(result, null, 2)}`, 'info');
                
                if (result.success) {
                    log('login-result', '‚úÖ Login realizado com sucesso!', 'success');
                    log('login-result', `Usu√°rio: ${result.user.name}`, 'success');
                } else {
                    log('login-result', `‚ùå Falha no login: ${result.error}`, 'error');
                    log('login-result', 'Poss√≠veis causas:', 'warning');
                    log('login-result', '- Usu√°rio demo n√£o foi criado no banco', 'warning');
                    log('login-result', '- Hash da senha incorreto', 'warning');
                    log('login-result', '- Problema na configura√ß√£o', 'warning');
                }
                
            } catch (error) {
                log('login-result', `‚ùå Erro no teste de login: ${error.message}`, 'error');
            }
        }

        async function listarUsuarios() {
            clearLog('usuarios-result');
            
            try {
                log('usuarios-result', 'Listando usu√°rios cadastrados...', 'info');
                
                const response = await fetch(`${SUPABASE_CONFIG.url}/rest/v1/users?select=id,name,email,subscription`, {
                    headers: {
                        'apikey': SUPABASE_CONFIG.anonKey,
                        'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                    }
                });
                
                if (response.ok) {
                    const usuarios = await response.json();
                    log('usuarios-result', `‚úÖ Encontrados ${usuarios.length} usu√°rio(s):`, 'success');
                    
                    usuarios.forEach((user, index) => {
                        log('usuarios-result', `${index + 1}. ${user.name} (${user.email}) - Plano: ${user.subscription}`, 'info');
                    });
                    
                    if (usuarios.length === 0) {
                        log('usuarios-result', '‚ö†Ô∏è Nenhum usu√°rio encontrado. Execute o SQL de setup!', 'warning');
                    }
                } else {
                    log('usuarios-result', `‚ùå Erro ao listar usu√°rios: ${response.status}`, 'error');
                    log('usuarios-result', await response.text(), 'error');
                }
                
            } catch (error) {
                log('usuarios-result', `‚ùå Erro: ${error.message}`, 'error');
            }
        }

        async function executarTodosOsTestes() {
            clearLog('completo-result');
            
            log('completo-result', 'üöÄ Iniciando bateria de testes...', 'info');
            
            // Teste 1: Configura√ß√£o
            log('completo-result', '\n=== TESTE 1: CONFIGURA√á√ÉO ===', 'info');
            try {
                if (SUPABASE_CONFIG && supabase) {
                    log('completo-result', '‚úÖ Configura√ß√£o OK', 'success');
                } else {
                    log('completo-result', '‚ùå Configura√ß√£o FALHOU', 'error');
                    return;
                }
            } catch (error) {
                log('completo-result', `‚ùå Erro na configura√ß√£o: ${error.message}`, 'error');
                return;
            }
            
            // Teste 2: Conex√£o
            log('completo-result', '\n=== TESTE 2: CONEX√ÉO ===', 'info');
            try {
                const response = await fetch(`${SUPABASE_CONFIG.url}/rest/v1/`, {
                    headers: {
                        'apikey': SUPABASE_CONFIG.anonKey,
                        'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                    }
                });
                
                if (response.ok) {
                    log('completo-result', '‚úÖ Conex√£o OK', 'success');
                } else {
                    log('completo-result', '‚ùå Conex√£o FALHOU', 'error');
                    return;
                }
            } catch (error) {
                log('completo-result', `‚ùå Erro de conex√£o: ${error.message}`, 'error');
                return;
            }
            
            // Teste 3: Tabelas
            log('completo-result', '\n=== TESTE 3: TABELAS ===', 'info');
            const tabelas = ['users', 'extintores'];
            let tabelasOK = true;
            
            for (const tabela of tabelas) {
                try {
                    const response = await fetch(`${SUPABASE_CONFIG.url}/rest/v1/${tabela}?limit=1`, {
                        headers: {
                            'apikey': SUPABASE_CONFIG.anonKey,
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                        }
                    });
                    
                    if (response.ok) {
                        log('completo-result', `‚úÖ Tabela "${tabela}" OK`, 'success');
                    } else {
                        log('completo-result', `‚ùå Tabela "${tabela}" FALHOU`, 'error');
                        tabelasOK = false;
                    }
                } catch (error) {
                    log('completo-result', `‚ùå Erro na tabela "${tabela}": ${error.message}`, 'error');
                    tabelasOK = false;
                }
            }
            
            if (!tabelasOK) {
                log('completo-result', '‚ùå Execute o SQL de setup no Supabase!', 'error');
                return;
            }
            
            // Teste 4: Login
            log('completo-result', '\n=== TESTE 4: LOGIN ===', 'info');
            try {
                const result = await supabase.login('demo@exemplo.com', '123456');
                
                if (result.success) {
                    log('completo-result', '‚úÖ Login OK', 'success');
                } else {
                    log('completo-result', `‚ùå Login FALHOU: ${result.error}`, 'error');
                    return;
                }
            } catch (error) {
                log('completo-result', `‚ùå Erro no login: ${error.message}`, 'error');
                return;
            }
            
            // Resultado final
            log('completo-result', '\nüéâ TODOS OS TESTES PASSARAM!', 'success');
            log('completo-result', '‚úÖ O Supabase est√° configurado corretamente', 'success');
            log('completo-result', '‚úÖ Voc√™ pode usar o app normalmente', 'success');
        }

        // Executar teste b√°sico ao carregar a p√°gina
        window.addEventListener('load', () => {
            setTimeout(testarConfiguracao, 500);
        });
    </script>
</body>
</html>
